---
phase: 03-visualization-ux
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - index.html
  - src/ui/app.ts
autonomous: false

must_haves:
  truths:
    - "Live chart updates smoothly during SA execution showing Wiener Index vs step"
    - "Best molecular structure renders as 2D drawing that updates when a new best is found"
    - "Algorithm state (step, temperature, current/best Wiener Index) is visible during execution"
    - "UI is readable when projected at 1920x1080 (large fonts, high contrast)"
    - "Layout adapts to mobile/tablet screens (single column, touch-friendly buttons)"
  artifacts:
    - path: "index.html"
      provides: "Complete responsive UI with chart canvas, molecule canvas, algorithm state panel"
      contains: "wiener-chart"
    - path: "src/ui/app.ts"
      provides: "Alpine component wired to chart and molecule renderer modules"
      contains: "addChartDataPoint"
  key_links:
    - from: "src/ui/app.ts"
      to: "src/ui/chart.ts"
      via: "import and call addChartDataPoint in progress callback"
      pattern: "addChartDataPoint"
    - from: "src/ui/app.ts"
      to: "src/ui/molecule-renderer.ts"
      via: "import and call renderMolecule when bestSMILES changes"
      pattern: "renderMolecule"
    - from: "index.html"
      to: "src/ui/app.ts"
      via: "Alpine x-data directives and canvas element IDs"
      pattern: "wiener-chart|molecule-canvas"
---

<objective>
Wire Chart.js and molecule renderer into the Alpine.js UI, redesign the layout with responsive CSS for classroom projection and mobile devices.

Purpose: This is the final integration plan that brings all Phase 3 work together. Students will see the live Wiener Index chart update during SA execution, the best molecule rendered as a 2D chemical structure, and algorithm state displayed prominently. The UI must be classroom-ready (projector-visible fonts, high contrast) and mobile-friendly (BYOD Chromebooks and tablets).

Output: Fully integrated visualization UI with live chart, molecule rendering, algorithm state display, and responsive layout.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visualization-ux/03-RESEARCH.md
@.planning/phases/03-visualization-ux/03-01-SUMMARY.md
@.planning/phases/03-visualization-ux/03-02-SUMMARY.md
@src/ui/app.ts
@src/ui/chart.ts
@src/ui/molecule-renderer.ts
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire chart and molecule renderer into Alpine app component</name>
  <files>src/ui/app.ts</files>
  <action>
Update src/ui/app.ts to integrate the chart and molecule renderer modules.

**1. Add imports at top of file:**
```typescript
import { createWienerChart, addChartDataPoint, resetChart, destroyChart } from './chart';
import { renderMolecule, clearMoleculeCanvas } from './molecule-renderer';
```

**2. Add state field for tracking previous best energy:**
Add `_prevBestEnergy: null as number | null` to the component return object.

**3. Update the init() method:**
After RDKit initialization (existing code), add chart initialization:
```typescript
// Initialize chart on canvas (after Alpine has rendered the DOM)
this.$nextTick(() => {
  const chartCanvas = document.getElementById('wiener-chart') as HTMLCanvasElement;
  if (chartCanvas) {
    createWienerChart(chartCanvas);
  }
  const molCanvas = document.getElementById('molecule-canvas') as HTMLCanvasElement;
  if (molCanvas) {
    clearMoleculeCanvas(molCanvas);
  }
});
```

**4. Update the progress callback inside start():**
In the `Comlink.proxy((data: SAProgressData) => { ... })` callback, after the existing `self.progress = { ...data };` line, add:

```typescript
// Update chart with new data point
addChartDataPoint(data.step, data.bestEnergy);

// Re-render molecule only when best energy changes (new best structure found)
if (data.bestSMILES && data.bestEnergy !== self._prevBestEnergy) {
  const molCanvas = document.getElementById('molecule-canvas') as HTMLCanvasElement;
  if (molCanvas) {
    renderMolecule(data.bestSMILES, molCanvas);
  }
  self._prevBestEnergy = data.bestEnergy;
}
```

**5. Update the reset() method:**
After `destroyWorker()`, add:
```typescript
resetChart();
this._prevBestEnergy = null;
const molCanvas = document.getElementById('molecule-canvas') as HTMLCanvasElement;
if (molCanvas) {
  clearMoleculeCanvas(molCanvas);
}
```

**6. Update the result handling after SA completes:**
After `this.state = 'complete';`, render the final best molecule:
```typescript
// Render final best molecule
if (this.progress?.bestSMILES) {
  const molCanvas = document.getElementById('molecule-canvas') as HTMLCanvasElement;
  if (molCanvas) {
    renderMolecule(this.progress.bestSMILES, molCanvas);
  }
}
```

**Important:** Chart and molecule renderer functions are imported as regular functions (NOT stored in Alpine reactive data). They operate on module-level state internally, which is the established pattern from Phase 2 for avoiding Proxy-of-Proxy conflicts.
  </action>
  <verify>
Verify `npx tsc --noEmit` passes.
Verify `npx vitest run` — all existing tests pass.
  </verify>
  <done>Alpine app component calls chart and molecule renderer functions during SA execution. Chart updates on every progress callback. Molecule re-renders only when best energy improves. Reset clears both chart and molecule canvas. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign index.html with responsive layout, chart, molecule canvas, and algorithm state</name>
  <files>index.html</files>
  <action>
Complete redesign of index.html with visualization panels, responsive CSS, and classroom-projection-ready typography.

**1. Replace the `<style>` block with responsive CSS using rem units and clamp():**

Root styles:
- `:root { font-size: 16px; }` (NEVER change — accessibility)
- Body: `font-size: clamp(1rem, 0.9rem + 0.5vw, 1.125rem)`, line-height 1.5, color #333, background #f5f5f5
- Container: max-width 1200px (up from 900px to fit chart + molecule side-by-side on large screens), padding `clamp(1rem, 2vw, 2rem)`

Typography (classroom projection readable):
- h1: `clamp(1.75rem, 1.5rem + 1vw, 2.5rem)`, color #1a1a1a
- h2: `clamp(1.25rem, 1rem + 0.75vw, 1.75rem)`, color #2a2a2a, border-bottom 2px solid #e0e0e0
- h3: `clamp(1.125rem, 1rem + 0.5vw, 1.375rem)`, color #3a3a3a

Form elements:
- Input/select padding: 0.625rem (10px at default), border 2px solid #ddd, font-size 1rem
- Min touch target: 44px height for buttons (accessibility)
- Buttons: padding 0.75rem 1.5rem, font-size 1rem, font-weight 600

Algorithm state panel (`.algo-state`):
- Font-size: `clamp(1.125rem, 1rem + 0.5vw, 1.375rem)`
- Font-weight: 600
- Display as a grid: 2x2 on desktop, 1-column on mobile
- Each stat: label (small, muted color) above value (large, bold, dark)
- Key numbers (Wiener Index values) get a larger font: `clamp(1.25rem, 1.125rem + 0.5vw, 1.5rem)`

Visualization area (`.viz-panel`):
- On desktop (min-width: 900px): 2-column grid — chart on left (60%), molecule on right (40%)
- On tablet/mobile: single column, chart above molecule
- Chart canvas container: aspect-ratio 2.5, width 100%
- Molecule canvas: width 100%, height auto, min-height 250px, max-height 400px
- Canvas elements need explicit width/height attributes for proper rendering (set via CSS or HTML attributes)

Progress bar:
- Keep existing progress bar but use rem units
- Height: 1.875rem (30px at default), border-radius 0.25rem

Mobile breakpoints (mobile-first with min-width):
- Base (all screens): single column, stacked layout
- `@media (min-width: 768px)`: param-grid becomes 2 columns, viz-panel becomes 2 columns, controls become horizontal row
- `@media (min-width: 1366px)`: container max-width increases to 1200px, chart height increases for projection

Accessibility:
- `@media (prefers-reduced-motion: reduce)`: disable all transitions/animations
- `@media (prefers-contrast: high)`: increase border contrast, use pure black/white
- All buttons min-height 44px (touch target)
- Focus outlines on interactive elements (don't remove outline)

**2. Restructure the HTML body:**

Keep existing Alpine.js x-data="app" wrapper. Reorganize sections:

```
Container (x-data="app")
├── Header: h1 "WebFaulon" + subtitle
├── Section: Molecular Formula
│   ├── Preset selector (existing)
│   └── Manual formula input (existing)
├── Section: SA Parameters (existing param-grid)
├── Section: Execution Controls
│   ├── Button row: Start, Pause, Resume, Reset (existing)
│   └── Progress bar (existing)
├── Section: Visualization (NEW — visible when running or complete)
│   ├── Algorithm State Panel (NEW)
│   │   ├── Current Step / Total Steps
│   │   ├── Temperature
│   │   ├── Current Wiener Index
│   │   └── Best Wiener Index
│   ├── Viz Panel (2-column on desktop)
│   │   ├── Chart: <canvas id="wiener-chart"></canvas>
│   │   └── Molecule: <canvas id="molecule-canvas" width="400" height="400"></canvas>
│   └── Best SMILES display (small monospace text showing current best SMILES string)
├── Section: Results (existing, visible when complete)
│   ├── Best Wiener Index, Initial Wiener Index
│   ├── Accepted/Rejected/Invalid counts
│   └── Acceptance Ratio
└── Footer: RDKit status (existing, move to bottom or make subtle)
```

**3. Algorithm state panel Alpine bindings:**
Use x-show="progress" to only show during/after execution.
- Step: `<span x-text="progress?.step || 0"></span> / <span x-text="progress?.totalSteps || 0"></span>`
- Temperature: `<span x-text="progress?.temperature?.toFixed(2) || '-'"></span>`
- Current W: `<span x-text="progress?.currentEnergy || '-'"></span>`
- Best W: `<span x-text="progress?.bestEnergy || '-'"></span>` (highlighted, larger)

**4. Canvas elements:**
- Chart canvas: `<canvas id="wiener-chart"></canvas>` inside a responsive container div
- Molecule canvas: `<canvas id="molecule-canvas" width="400" height="400"></canvas>` (explicit dimensions for RDKit, CSS can scale for display)

**5. Color scheme:**
- Primary blue: #3b82f6 (blue-500) for buttons, chart line, active states
- Success green: #22c55e for valid states
- Error red: #ef4444 for errors
- Text: #1a1a1a (headings), #333 (body), #6b7280 (muted labels)
- Background: #f9fafb (page), #ffffff (container)
- Border: #e5e7eb (subtle), #d1d5db (form inputs)

**6. Remove inline progress text** that duplicated algorithm state info (current/best/temp were shown in a `<p>` under progress bar — this is now in the dedicated Algorithm State Panel).
  </action>
  <verify>
Run `npx vite build` — builds without errors.
Run `npx tsc --noEmit` — no type errors.
Open `npx vite` dev server and verify:
- Chart canvas and molecule canvas are visible
- Layout is responsive (resize browser)
- Text is readable at small and large sizes
  </verify>
  <done>index.html has responsive design with rem/clamp typography, 2-column viz layout on desktop, single column on mobile, algorithm state panel, chart canvas, molecule canvas, classroom-projection-ready fonts and contrast, accessible touch targets. Builds and compiles without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete visualization experience</name>
  <files>index.html, src/ui/app.ts</files>
  <action>
Human verification checkpoint. What was built: Complete Phase 3 visualization — live Wiener Index chart, 2D molecule rendering, algorithm state display, and responsive layout, all integrated with SA execution.

Start dev server with `npx vite` and open http://localhost:5173 in browser.

**Test 1 — Chart visualization:**
- Select "Hexane isomers" (C6H14) preset
- Click Start
- Verify: Live chart appears showing Wiener Index vs step, updating smoothly as SA runs
- Verify: Chart shows peaks and valleys (SA explores different structures)
- Wait for completion, verify chart shows full run history

**Test 2 — Molecule rendering:**
- While SA is running (or after completion), verify: 2D chemical structure is drawn on the molecule canvas
- Verify: Structure looks like a molecular drawing (atoms, bonds, proper chemical depiction)
- Verify: Structure updates when a new best molecule is found (watch for changes during early SA steps)

**Test 3 — Algorithm state display:**
- During SA execution, verify all four stats are visible and updating:
  - Current Step / Total Steps (incrementing)
  - Temperature (decreasing with f8 cooling)
  - Current Wiener Index (changing each step)
  - Best Wiener Index (only improves, highlighted)

**Test 4 — Responsive layout:**
- Desktop (>900px): Chart and molecule side-by-side
- Resize to tablet width (~768px): Layout should stack if needed
- Resize to mobile width (~375px): Everything single column, buttons full-width
- Verify text remains readable at all sizes

**Test 5 — Classroom projection test:**
- Zoom browser to 150% or use DevTools to simulate 1920x1080
- Verify: All text is easily readable, good contrast, no horizontal scrolling
- Headings should be large and clear

**Test 6 — Full cycle:**
- Click Reset, change to "Decane isomers" (C10H22), set 500 steps x 4 cycles
- Click Start, let it run
- Pause execution — verify chart and molecule freeze
- Resume — verify chart and molecule continue updating
- Wait for completion — verify results section appears with final statistics
  </action>
  <verify>All 6 tests pass: chart updates live, molecule renders correctly, algorithm state visible, responsive layout works, projection-readable, full start/pause/resume/reset cycle works.</verify>
  <done>Human approved: Complete visualization experience works as designed — live chart, molecule rendering, algorithm state, responsive layout all functional and classroom-ready.</done>
</task>

</tasks>

<verification>
1. `npx vite build` — production build succeeds
2. `npx tsc --noEmit` — no type errors
3. `npx vitest run` — all tests pass
4. Live chart updates during SA execution without frame drops
5. Molecule renders correctly and updates on new best
6. Algorithm state is visible and accurate
7. Layout is responsive across desktop, tablet, and mobile
8. Human verification confirms classroom-ready visualization
</verification>

<success_criteria>
- Live chart displays Wiener Index vs step number, updating smoothly during SA execution
- Current best molecular structure renders as 2D chemical drawing using RDKit.js
- Algorithm state (step, temperature, current/best Wiener Index) visible throughout execution
- UI is readable when projected (clean design, good contrast, large fonts)
- Layout works on tablets and phones (mobile responsive)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization-ux/03-03-SUMMARY.md`
</output>
