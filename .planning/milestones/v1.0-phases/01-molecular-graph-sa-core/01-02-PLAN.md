---
phase: 01-molecular-graph-sa-core
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/core/formulaParser.ts
  - src/core/initialStructure.ts
  - src/core/__tests__/formulaParser.test.ts
  - src/core/__tests__/initialStructure.test.ts
autonomous: true

must_haves:
  truths:
    - "Parsing 'C6H14' produces {C: 6, H: 14}"
    - "Parsing 'C8H10' produces {C: 8, H: 10}"
    - "Initial structure from C6H14 is a connected graph with 6 carbon atoms"
    - "Initial structure from C6H14 has valid valences (all carbons at valence 4)"
    - "Initial structure from C6H6 contains double bonds or rings (HDI=4)"
    - "Invalid formulas (C6H99, empty string) produce clear errors"
  artifacts:
    - path: "src/core/formulaParser.ts"
      provides: "Molecular formula parsing and HDI calculation"
      exports: ["parseFormula", "FormulaMap", "computeHDI"]
      min_lines: 30
    - path: "src/core/initialStructure.ts"
      provides: "Deterministic initial structure generation from formula"
      exports: ["generateInitialStructure"]
      min_lines: 60
    - path: "src/core/__tests__/formulaParser.test.ts"
      provides: "Formula parser tests"
      contains: "describe.*parseFormula"
    - path: "src/core/__tests__/initialStructure.test.ts"
      provides: "Initial structure generation tests"
      contains: "describe.*initialStructure"
  key_links:
    - from: "src/core/initialStructure.ts"
      to: "src/core/MolGraph.ts"
      via: "imports MolGraph constructor to build graph from formula"
      pattern: "import.*MolGraph"
    - from: "src/core/initialStructure.ts"
      to: "src/core/formulaParser.ts"
      via: "imports parseFormula to convert formula string to atom counts"
      pattern: "import.*parseFormula"
---

<objective>
Implement molecular formula parsing and deterministic initial structure generation using TDD. Given a formula like "C6H14", produce a valid, connected molecular graph that SA can use as its starting point.

Purpose: ALG-02 requires deterministic initial structure generation from molecular formulas. SA needs a valid starting graph -- this plan produces one. The research recommends a deterministic linear chain approach: arrange heavy atoms in a chain, then add double/triple bonds to satisfy the hydrogen deficiency index (HDI).
Output: Formula parser, HDI calculator, and initial structure generator with comprehensive test suite.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-molecular-graph-sa-core/01-RESEARCH.md
@.planning/phases/01-molecular-graph-sa-core/01-01-SUMMARY.md
</context>

<feature>
  <name>Initial Structure Generation from Molecular Formula</name>
  <files>
    src/core/formulaParser.ts, src/core/__tests__/formulaParser.test.ts,
    src/core/initialStructure.ts, src/core/__tests__/initialStructure.test.ts
  </files>
  <behavior>
**Formula Parser (src/core/formulaParser.ts):**

Input: molecular formula string (e.g., "C6H14", "C8H10", "C2H6O")
Output: FormulaMap (Record of element symbol to count)

Cases:
- "C6H14" -> {C: 6, H: 14}
- "C8H10" -> {C: 8, H: 10}
- "CH4" -> {C: 1, H: 4}  (implicit count of 1)
- "C2H6O" -> {C: 2, H: 6, O: 1}
- "C6H5Cl" -> {C: 6, H: 5, Cl: 1}
- "" -> throws Error("Empty formula")
- "C6H99" -> parsed successfully (validation is separate)
- "XYZ" -> throws Error("Unknown element: X")

HDI (Hydrogen Deficiency Index) calculation:
- HDI = (2C + 2 + N - H - Halogens) / 2  (for CHNO + halogens)
- C6H14: HDI = (12 + 2 - 14) / 2 = 0 (saturated)
- C6H12: HDI = (12 + 2 - 12) / 2 = 1 (one ring or double bond)
- C6H6: HDI = (12 + 2 - 6) / 2 = 4 (benzene -- 3 double bonds + 1 ring)
- C2H6O: HDI = (4 + 2 - 6) / 2 = 0 (saturated ether/alcohol)

**Initial Structure Generator (src/core/initialStructure.ts):**

Input: formula string
Output: MolGraph that is connected and has valid valences

Algorithm (deterministic, from research recommendation):
1. Parse formula to get heavy atom counts
2. Create array of heavy atoms (all carbons first, then heteroatoms)
3. Connect all heavy atoms in a linear chain (single bonds)
4. Compute HDI from formula
5. If HDI > 0: add extra bonds (double/triple) to satisfy unsaturation
   - Walk the chain and upgrade single bonds to double bonds until HDI is satisfied
   - Each double bond reduces HDI by 1, each triple bond reduces by 2
6. Compute implicitH for each atom
7. Validate: total implicit H must match formula's H count
8. If H count doesn't match: error (formula not achievable with simple chain)

Cases:
- "C6H14" -> linear hexane chain, 5 single C-C bonds, all valences valid, HDI=0
- "C4H10" -> linear butane, 3 single C-C bonds
- "C6H12" -> linear chain with one C=C double bond (HDI=1)
- "C6H6" -> chain with 4 units of unsaturation distributed as double bonds
- "C2H6O" -> C-O-C or C-C-O chain, HDI=0
- "CH4" -> single carbon, no heavy-heavy bonds
- Formula with impossible H count -> throw descriptive error
  </behavior>
  <implementation>
**RED phase:** Write tests first for both formulaParser and initialStructure.

For formulaParser tests: test parsing various formulas to FormulaMap, test HDI calculations against known values, test error cases (empty formula, unknown elements).

For initialStructure tests: test that generated graphs are connected, have valid valences, have correct atom counts, and that implicit H matches the formula. Test with C6H14, C4H10, C6H12, C6H6, CH4, C2H6O.

**GREEN phase:** Implement minimal code to pass all tests.

formulaParser: Use regex to extract element symbols (capital letter + optional lowercase) and counts (digits following element, default 1). Build FormulaMap. Validate elements against known set.

initialStructure: Build heavy atom array, connect as chain, add unsaturation bonds, compute implicit H, validate against formula H count.

**REFACTOR phase:** Clean up any duplicate logic. Ensure parseFormula handles edge cases gracefully. Extract STANDARD_VALENCE usage to be consistent with types.ts.

Note on heteroatoms: For formulas with O, N, S, etc., place heteroatoms in the chain alongside carbons. The specific ordering (all C first, then O at end, etc.) affects the initial structure but not SA correctness -- SA will rearrange via displacement. The deterministic algorithm just needs to produce ANY valid starting structure.
  </implementation>
</feature>

<verification>
1. `npm test -- --run src/core/__tests__/formulaParser.test.ts` -- all parser tests pass
2. `npm test -- --run src/core/__tests__/initialStructure.test.ts` -- all structure tests pass
3. `npm test -- --run` -- full suite still passes (no regressions)
4. `npx tsc --noEmit` -- zero TypeScript errors
5. Generated structures for C6H14, C6H12, C6H6 all pass isConnected() and hasValidValences()
</verification>

<success_criteria>
- parseFormula correctly parses 6+ formula formats including heteroatoms
- computeHDI matches known values for C6H14 (0), C6H12 (1), C6H6 (4)
- generateInitialStructure produces valid, connected graphs for saturated and unsaturated formulas
- Implicit hydrogen count in generated graph matches formula's hydrogen count
- Error handling for invalid/impossible formulas
- 15+ tests passing across both test files
</success_criteria>

<output>
After completion, create `.planning/phases/01-molecular-graph-sa-core/01-02-SUMMARY.md`
</output>
