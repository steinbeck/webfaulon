# Summary: 06.1-01 — Unsaturated molecule displacement fix and efficiency improvement

**Status:** Complete
**Date:** 2026-02-16

## What Was Done

Fixed two critical issues preventing displacement on unsaturated molecules:

1. **Removed SanitizeMol from set_bond()** — RDKit's `SanitizeMol()` was converting alternating SINGLE/DOUBLE bonds (Kekule form) to AROMATIC type (1.5 order), crashing `bond_type_to_order()` which only mapped integer orders. The fix: remove sanitization entirely from `set_bond()`, since Faulon equations 7-9 preserve valence by construction. This was both simpler and more correct than the originally planned `sanitize_kekulized()` helper approach.

2. **Added AROMATIC→1 fallback in bond_type_to_order()** — Safety net in `rdkit_helpers.py` maps `BondType.AROMATIC` to integer order 1. With SanitizeMol removed from set_bond(), AROMATIC bonds shouldn't appear during displacement, but this prevents crashes if molecules enter the system with aromatic bonds from external SMILES.

3. **Added no-op displacement retry** — Sparse graphs (long chains like C10H22) produce identity displacements where randomly selected atoms share no bonds (b == a). `attempt_displacement()` now retries up to `MAX_DISPLACEMENT_ATTEMPTS = 10` times to find non-trivial bond changes.

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Remove SanitizeMol from set_bond() entirely (not replace with kekulized version) | Faulon eqs 7-9 preserve valence by construction — sanitization was redundant AND caused AROMATIC crashes |
| AROMATIC→1 mapping (not →2) | Conservative: prevents valence violations. Kekulization makes this a safety net only |
| Keep SanitizeMol in initial_structure.py and has_valid_valences() | Needed once for implicit H calculation (initial) and for testing (validation) |
| MAX_DISPLACEMENT_ATTEMPTS = 10 | Balances retry cost vs success probability on sparse graphs |

## Deviation from Plan

The original plan called for a `sanitize_kekulized()` helper function, `Chem.Kekulize()` in the constructor, and `kekuleSmiles=True` in `to_smiles()`. The actual implementation took a simpler approach: just remove SanitizeMol from the hot path entirely. This eliminated the problem at the source rather than working around it.

## Files Changed

- `backend/app/utils/rdkit_helpers.py` — Added AROMATIC fallback to bond_type_to_order()
- `backend/app/core/molecule.py` — Removed SanitizeMol from set_bond(), added explanatory comment
- `backend/app/core/displacement.py` — Added MAX_DISPLACEMENT_ATTEMPTS retry loop, no-op detection
