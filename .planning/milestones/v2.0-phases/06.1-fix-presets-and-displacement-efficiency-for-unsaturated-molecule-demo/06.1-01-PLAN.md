---
phase: 06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/utils/rdkit_helpers.py
  - backend/app/core/molecule.py
  - backend/app/core/displacement.py
autonomous: true

must_haves:
  truths:
    - "bond_type_to_order() handles AROMATIC bond type as safety fallback (maps to 1)"
    - "set_bond() does NOT call SanitizeMol — Faulon displacement preserves valence by construction"
    - "attempt_displacement() retries up to MAX_DISPLACEMENT_ATTEMPTS (10) to find non-trivial bond changes"
    - "Disconnected displacement results are returned (connectivity checked by SA engine, not displacement)"
    - "Existing saturated molecule tests still pass unchanged"
  artifacts:
    - path: "backend/app/utils/rdkit_helpers.py"
      provides: "AROMATIC fallback in bond_type_to_order()"
      contains: "AROMATIC"
    - path: "backend/app/core/molecule.py"
      provides: "set_bond() without SanitizeMol, using Faulon valence-preservation guarantee"
      contains: "No sanitization needed"
    - path: "backend/app/core/displacement.py"
      provides: "attempt_displacement() with no-op retry logic"
      contains: "MAX_DISPLACEMENT_ATTEMPTS"
---

<objective>
Fix displacement crashes on unsaturated molecules (benzene, naphthalene) and improve displacement efficiency on sparse graphs.

Root cause: RDKit SanitizeMol() in set_bond() converts alternating SINGLE/DOUBLE bonds to AROMATIC type (1.5 order), which is incompatible with Faulon's integer bond orders (0-3). Secondary issue: sparse graphs (long chains) produce many no-op displacements.

Approach taken: (1) Remove SanitizeMol from set_bond() entirely — Faulon equations 7-9 preserve valence by construction, making post-sanitization redundant. (2) Add AROMATIC→1 fallback in bond_type_to_order() as safety net. (3) Add no-op displacement retry logic (up to 10 attempts).
</objective>

<context>
@.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-RESEARCH.md
@backend/app/utils/rdkit_helpers.py
@backend/app/core/molecule.py
@backend/app/core/displacement.py
</context>

<feature>
  <name>Unsaturated molecule displacement fix and efficiency improvement</name>
  <files>backend/app/utils/rdkit_helpers.py, backend/app/core/molecule.py, backend/app/core/displacement.py</files>
  <behavior>
    1. bond_type_to_order(BondType.AROMATIC) returns 1 (safety fallback, not crash)
    2. set_bond() modifies bond orders without calling SanitizeMol (valence preserved by Faulon eqs 7-9)
    3. attempt_displacement() retries up to 10 times to find non-trivial bond changes on sparse graphs
    4. Displacement on benzene/naphthalene runs without "Cannot map bond type AROMATIC" crash
    5. All existing saturated molecule tests pass unchanged
  </behavior>
  <implementation>
    **Step 1: Add AROMATIC fallback to bond_type_to_order() in rdkit_helpers.py**
    Add `BondType.AROMATIC: 1` to type_map dict as safety fallback.

    **Step 2: Remove SanitizeMol from set_bond() in molecule.py**
    Replace the try/except SanitizeMol block with a comment explaining why sanitization
    is skipped: Faulon displacement preserves valence by construction (equations 7-9).

    **Step 3: Add no-op retry logic to attempt_displacement() in displacement.py**
    Add MAX_DISPLACEMENT_ATTEMPTS = 10 constant. Wrap atom selection + displacement in
    a retry loop that skips no-op displacements (where b == a, nothing changes). Sparse
    graphs produce many identity displacements because randomly selected atoms share no bonds.
  </implementation>
</feature>

<verification>
1. `grep 'AROMATIC' backend/app/utils/rdkit_helpers.py` finds the fallback mapping
2. `grep -c 'SanitizeMol' backend/app/core/molecule.py` shows SanitizeMol only in has_valid_valences (not set_bond)
3. `grep 'MAX_DISPLACEMENT_ATTEMPTS' backend/app/core/displacement.py` finds the retry constant
4. `cd backend && python -m pytest tests/ -v` -- full test suite passes
</verification>
