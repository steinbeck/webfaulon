---
phase: 06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo
plan: 02
type: tdd
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - backend/tests/test_displacement.py
  - backend/tests/test_sa_engine.py
autonomous: true

must_haves:
  truths:
    - "Displacement on benzene succeeds without crashing over 100 attempts"
    - "Displacement on naphthalene succeeds without crashing over 100 attempts"
    - "Bond orders stay in [0, 3] for unsaturated displacement results"
    - "Full SA optimization on C6H6, C10H8, C10H16 completes without crashing"
    - "All 6 preset formulas (C6H14, C8H18, C8H10, C10H22, C10H16, C10H8) complete SA without errors"
    - "Disconnected moves tracked separately from invalid moves"
    - "Existing displacement and SA engine tests still pass"
  artifacts:
    - path: "backend/tests/test_displacement.py"
      provides: "TestUnsaturatedDisplacement class with benzene/naphthalene tests"
      contains: "TestUnsaturatedDisplacement"
    - path: "backend/tests/test_sa_engine.py"
      provides: "TestUnsaturatedMolecules, TestAllPresetFormulas, TestDisconnectedMoveAccounting classes"
      contains: "TestUnsaturatedMolecules"
---

<objective>
Add integration-level tests verifying that displacement and full SA optimization work correctly on unsaturated/aromatic molecules after the Plan 01 fix. Verify all 6 frontend preset molecules run end-to-end. Add disconnected move accounting tests.
</objective>

<context>
@.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-RESEARCH.md
@backend/app/core/displacement.py
@backend/app/core/sa_engine.py
@backend/tests/test_displacement.py
@backend/tests/test_sa_engine.py
</context>

<feature>
  <name>Integration tests for unsaturated molecule displacement and SA optimization</name>
  <files>backend/tests/test_displacement.py, backend/tests/test_sa_engine.py</files>
  <behavior>
    1. TestUnsaturatedDisplacement: benzene and naphthalene displacement doesn't crash, bond orders stay in [0,3]
    2. TestUnsaturatedMolecules: parametrized SA on C6H6, C10H8, C10H16 completes with valid results
    3. TestAllPresetFormulas: parametrized SA on all 6 frontend presets completes with valid SMILES
    4. TestDisconnectedMoveAccounting: disconnected moves tracked separately, all move types sum to total steps
  </behavior>
  <implementation>
    **Task 1: Add TestUnsaturatedDisplacement to test_displacement.py**
    - test_benzene_displacement_no_crash: 100 displacements on benzene, verify atom count preserved
    - test_naphthalene_displacement_no_crash: 100 displacements on naphthalene, verify atom count preserved
    - test_unsaturated_bond_orders_valid: verify all bond orders in [0, 3] after displacement

    **Task 2: Add test classes to test_sa_engine.py**
    - TestUnsaturatedMolecules: parametrized test on ["C6H6", "C10H8", "C10H16"], 100 steps x 2 cycles
    - TestAllPresetFormulas: parametrized test on all 6 presets, 200 steps x 2 cycles, verify valid SMILES
    - TestDisconnectedMoveAccounting: verify disconnected_moves >= 0 and all categories sum to total
  </implementation>
</feature>

<verification>
1. `cd backend && python -m pytest tests/test_displacement.py -v -k "Unsaturated"` -- unsaturated displacement tests pass
2. `cd backend && python -m pytest tests/test_sa_engine.py -v -k "Unsaturated or Preset or Disconnected"` -- all new SA tests pass
3. `cd backend && python -m pytest tests/ -v` -- full test suite passes (238 tests)
</verification>
