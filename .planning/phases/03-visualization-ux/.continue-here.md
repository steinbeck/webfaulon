---
phase: 03-visualization-ux
task: 3
total_tasks: 3
status: in_progress
last_updated: 2026-02-15T15:15:21.913Z
---

<current_state>
Phase 3, Plan 03-03 (UI Integration & Responsive Redesign) checkpoint.
Chart.js timeline works perfectly. Molecule rendering via MOL block approach is NOT YET WORKING — RDKit.js `get_mol()` throws a WASM exception when parsing our V2000 MOL block. Extensive debugging in progress.
</current_state>

<completed_work>

- Plan 03-01: SMILES generation + worker bestSMILES propagation - DONE (4 commits)
- Plan 03-02: Chart.js live chart + RDKit molecule renderer modules - DONE (3 commits)
- Plan 03-03 Task 1: Wired chart + molecule renderer into app.ts - DONE (commit 25d9e32)
- Plan 03-03 Task 2: Redesigned index.html with responsive layout - DONE (commit 4f5dba3)
- Plan 03-03 Task 3: Human verification checkpoint - IN PROGRESS (molecule rendering broken)
- Replaced buggy `toSMILES()` with `toMolBlock()` in MolGraph (V2000 MOL format)
- Renamed pipeline field `bestSMILES` → `bestMolBlock` in SAEngineState, SAProgressData, worker, app.ts
- Updated molecule-renderer.ts to accept MOL block, derive canonical SMILES via RDKit
- Updated index.html SMILES display to bind to Alpine-level `bestSMILES` (derived from RDKit)
- Added C10H16 ("Monoterpene isomers") to preset dropdown
- Fixed V2000 atom symbol column alignment (`padEnd(3)` instead of `padEnd(2)`)
- All 159 tests pass, TypeScript compiles clean, Vite builds
</completed_work>

<remaining_work>

- Fix molecule rendering: RDKit.js `get_mol()` throws WASM exception on our MOL block
- Complete Plan 03-03 human verification checkpoint (chart + molecule + responsive layout)
- Remove diagnostic logging from molecule-renderer.ts once rendering works
- Phase 3 wrap-up: aggregate results, verify phase goal, update roadmap
</remaining_work>

<decisions_made>

- Replaced `toSMILES()` with `toMolBlock()` because DFS-based SMILES generation was fundamentally buggy for complex ring systems (misattributed parent/child relationships, produced 5-bonded carbons). MOL block generation is trivially correct from adjacency matrix — no ring-closure logic needed.
- RDKit.js MinimalLib is READ-ONLY (no bond editing, no distance matrix) so the custom MolGraph adjacency matrix, displacement logic, and Wiener computation must all stay. RDKit is only useful for parsing/rendering.
- Pipeline sends MOL block from worker → main thread; main thread uses RDKit to parse, render, and derive canonical SMILES for display.
- User requested C10H16 added to presets (it's their test molecule).
</decisions_made>

<blockers>

- **BLOCKER: RDKit.js WASM exception on MOL block parsing**
  - `get_mol(molBlock)` throws a WASM pointer number (e.g., 2037528) instead of returning null
  - The MOL block IS being received (string, len=1024, contains V2000)
  - Python RDKit parses the same MOL block format correctly
  - Column alignment was fixed (atom symbol `padEnd(3)`) but issue persists
  - Latest code has diagnostic logging + sanitize:false fallback (not yet tested by user)
  - Possible causes to investigate:
    1. RDKit.js MinimalLib might not support MOL block input in `get_mol()` (unlikely per docs but possible)
    2. All-zero coordinates might cause issues (try non-degenerate coords)
    3. Bond line format: we output 7 fields, RDKit reference uses only 4 fields
    4. Missing trailing newline after `M  END`
    5. Header line missing "2D" dimension flag
  - **Recommended next step**: Try simplifying bond lines to 4 fields (match RDKit reference format), add trailing newline, add "2D" to header. If still fails, try hardcoded known-good MOL block to determine if `get_mol()` handles MOL blocks at all.
</blockers>

<context>
The fundamental architecture question was raised by the user: "could everything be done in RDKit?" — answer is NO because RDKit.js MinimalLib is read-only (parse/render/serialize only, no bond editing or distance matrix). So the custom MolGraph + displacement + Wiener computation must stay.

The MOL block approach is architecturally correct — the problem is purely in getting RDKit.js to parse our V2000 output. Python RDKit handles it fine. The issue is likely a minor format difference that the stricter WASM parser rejects.

Key files modified (all uncommitted):
- `src/core/MolGraph.ts` — toSMILES() replaced with toMolBlock()
- `src/core/types.ts` — bestSMILES → bestMolBlock in SAEngineState
- `src/worker/types.ts` — bestSMILES → bestMolBlock in SAProgressData
- `src/core/SAEngine.ts` — getState() calls toMolBlock()
- `src/worker/sa-worker.ts` — sends bestMolBlock
- `src/ui/molecule-renderer.ts` — accepts MOL block, derives SMILES, diagnostic logging
- `src/ui/app.ts` — uses bestMolBlock, stores derived bestSMILES for display
- `index.html` — SMILES display binds to bestSMILES
- `src/ui/presets.ts` — added C10H16
- `src/core/__tests__/MolGraph.test.ts` — toSMILES tests replaced with toMolBlock tests
</context>

<next_action>
Start with: Debug the RDKit.js MOL block parsing failure.

1. Check browser console for the latest diagnostic output (SMILES smoke test, get_mol error, unsanitized fallback, full MOL block dump)
2. Try matching RDKit's reference MOL block format exactly:
   - Bond lines: use 4 fields only (`  1  2  1  0`) instead of 7
   - Header line 2: add "2D" dimension flag (`  WebFaulon          2D`)
   - Add trailing newline after `M  END`
3. If format fixes don't work, try a hardcoded known-good MOL block in the renderer to determine if `get_mol()` supports MOL blocks in this RDKit.js version at all
4. If `get_mol()` truly can't parse MOL blocks, alternative: generate SMILES from MOL block via Python-like algorithm, or use `get_svg()` instead of canvas rendering
5. Once rendering works, remove diagnostic logging and complete the Phase 3 checkpoint
</next_action>
