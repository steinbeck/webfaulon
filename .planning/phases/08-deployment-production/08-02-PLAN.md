---
phase: 08-deployment-production
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - .env.production
autonomous: false

user_setup:
  - service: render
    why: "Backend hosting platform for FastAPI + RDKit"
    env_vars:
      - name: WEBFAULON_ALLOWED_ORIGINS
        source: "Render Dashboard -> Environment -> Add Environment Variable"
      - name: WEBFAULON_DEBUG
        source: "Render Dashboard -> Environment -> Add Environment Variable"
    dashboard_config:
      - task: "Create Render account and Web Service"
        location: "render.com -> Sign up -> New Web Service"

must_haves:
  truths:
    - "Backend responds to health check requests from the public internet"
    - "Frontend at GitHub Pages connects to deployed backend and runs an SA optimization"
    - "CORS rejects requests from unauthorized origins"
  artifacts:
    - path: ".env.production"
      provides: "Final production API URL pointing to actual Render service"
      contains: "VITE_API_URL"
  key_links:
    - from: "https://steinbeck.github.io/webfaulon/"
      to: "Render backend /api/sa/configure"
      via: "VITE_API_URL injected at build time"
      pattern: "fetch.*onrender\\.com"
---

<objective>
Deploy backend to Render and verify end-to-end production flow.

Purpose: Get the backend running on a cloud platform, update .env.production with the actual Render URL, rebuild and deploy the frontend, and verify the full production flow works.

Output: Live backend on Render, updated .env.production with real URL, working end-to-end on GitHub Pages
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-production/08-RESEARCH.md
@.planning/phases/08-deployment-production/08-01-SUMMARY.md
@backend/app/config.py
@backend/app/main.py
@backend/requirements.txt
@.env.production
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Render Web Service and deploy backend</name>
  <action>
The user must create a Render account and web service. Claude cannot automate this -- it requires browser-based account creation and service provisioning.
  </action>
  <instructions>
## Create Render Web Service

1. **Sign up at [render.com](https://render.com)** (free tier works for initial setup)

2. **Create a new Web Service:**
   - Click "New" -> "Web Service"
   - Connect your GitHub repository: `steinbeck/webfaulon`
   - **Root Directory:** `backend`
   - **Environment:** `Python 3`
   - **Build Command:** `pip install -r requirements.txt`
   - **Start Command:** `uvicorn app.main:app --host 0.0.0.0 --port $PORT`

3. **Set environment variables** in the Render dashboard (Environment tab):
   ```
   WEBFAULON_ALLOWED_ORIGINS=["https://steinbeck.github.io"]
   WEBFAULON_DEBUG=false
   ```

4. **Deploy** -- Render will auto-deploy from the main branch.

5. **Verify the health endpoint:**
   ```bash
   curl https://YOUR-SERVICE-NAME.onrender.com/health
   ```
   Expected response: `{"status":"healthy","version":"2.0.0"}`

6. **Report back the Render URL** (e.g., `https://webfaulon-backend.onrender.com`)
  </instructions>
  <resume-signal>Provide the Render backend URL (e.g., https://webfaulon-backend.onrender.com) or describe any issues encountered</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update .env.production with actual Render URL and verify CORS</name>
  <files>.env.production</files>
  <action>
1. Update `.env.production` with the actual Render URL provided by the user in the checkpoint resume signal. Replace the placeholder:

```
VITE_API_URL=https://ACTUAL-RENDER-URL.onrender.com
```

Use the exact URL the user provides (no trailing slash).

2. Verify CORS is properly locked down by running these curl commands against the deployed backend:

```bash
# Should succeed -- production origin
curl -i -H "Origin: https://steinbeck.github.io" https://ACTUAL-URL/health 2>&1 | grep -i "access-control"

# Should fail -- unauthorized origin (no CORS headers)
curl -i -H "Origin: https://evil.com" https://ACTUAL-URL/health 2>&1 | grep -i "access-control"
```

3. The GitHub Actions workflow will pick up the updated `.env.production` on the next push to main. After committing, the frontend will be rebuilt and deployed to GitHub Pages with the correct backend URL.
  </action>
  <verify>
- `cat .env.production` shows actual Render URL
- CORS curl test with production origin returns `Access-Control-Allow-Origin` header
- CORS curl test with unauthorized origin returns NO `Access-Control-Allow-Origin` header
- After push + GitHub Actions deploy: visit https://steinbeck.github.io/webfaulon/ and run an SA optimization end-to-end
  </verify>
  <done>.env.production has actual Render backend URL. CORS verified: production origin allowed, unauthorized origins rejected. Frontend rebuild will pick up the new URL.</done>
</task>

</tasks>

<verification>
1. `curl https://RENDER-URL/health` returns `{"status":"healthy","version":"2.0.0"}`
2. CORS test: `curl -i -H "Origin: https://steinbeck.github.io" https://RENDER-URL/health` includes `Access-Control-Allow-Origin` header
3. CORS rejection: `curl -i -H "Origin: https://evil.com" https://RENDER-URL/health` has NO `Access-Control-Allow-Origin` header
4. After deploy: https://steinbeck.github.io/webfaulon/ loads, user can select a preset, click Start, and see live SA progress
</verification>

<success_criteria>
- Backend is live on Render and responds to /health from the internet
- CORS is locked to https://steinbeck.github.io only
- .env.production contains the actual Render backend URL
- After GitHub Actions rebuilds frontend, the production site at https://steinbeck.github.io/webfaulon/ successfully runs SA optimization end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-production/08-02-SUMMARY.md`
</output>
