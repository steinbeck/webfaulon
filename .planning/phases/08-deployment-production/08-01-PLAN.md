---
phase: 08-deployment-production
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/requirements.txt
  - src/api/client.ts
  - src/api/sse.ts
  - .env.production
  - .github/workflows/deploy.yml
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "backend/requirements.txt contains all production dependencies including rdkit"
    - "Frontend build injects production backend URL from VITE_API_URL environment variable"
    - "SSE connection uses production backend URL when VITE_API_URL is set"
    - "GitHub Actions workflow passes VITE_API_URL to build step"
    - "Dev workflow unchanged -- Vite proxy still works when VITE_API_URL is unset"
  artifacts:
    - path: "backend/requirements.txt"
      provides: "Pip-installable production dependencies for Render"
      contains: "rdkit"
    - path: ".env.production"
      provides: "Vite build-time environment for production API URL"
      contains: "VITE_API_URL"
    - path: "src/api/client.ts"
      provides: "API client with environment-driven base URL"
      contains: "import.meta.env.VITE_API_URL"
    - path: "src/api/sse.ts"
      provides: "SSE connection with environment-driven base URL"
      contains: "import.meta.env.VITE_API_URL"
  key_links:
    - from: ".env.production"
      to: "src/api/client.ts"
      via: "Vite injects VITE_API_URL at build time"
      pattern: "import\\.meta\\.env\\.VITE_API_URL"
    - from: ".env.production"
      to: "src/api/sse.ts"
      via: "Vite injects VITE_API_URL at build time"
      pattern: "import\\.meta\\.env\\.VITE_API_URL"
    - from: ".github/workflows/deploy.yml"
      to: ".env.production"
      via: "Vite reads .env.production during npm run build"
---

<objective>
Prepare backend and frontend configuration files for cloud deployment.

Purpose: Create all files Render needs to deploy the backend (requirements.txt with rdkit) and configure the frontend to use the production backend URL via Vite environment variables. After this plan, a human can create the Render service and deploy.

Output: backend/requirements.txt, .env.production, updated client.ts/sse.ts with VITE_API_URL support, updated deploy.yml
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment-production/08-RESEARCH.md
@backend/pyproject.toml
@backend/app/config.py
@backend/app/main.py
@src/api/client.ts
@src/api/sse.ts
@.github/workflows/deploy.yml
@vite.config.ts
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend requirements.txt and add rdkit dependency</name>
  <files>backend/pyproject.toml, backend/requirements.txt</files>
  <action>
1. Add `rdkit = "^2025.9.4"` to `[tool.poetry.dependencies]` in `backend/pyproject.toml`. RDKit is already used by the backend code (imported as `from rdkit import Chem`) but was installed manually during development. It must be declared as an explicit dependency for deployment.

2. Create `backend/requirements.txt` with ALL production dependencies (NOT dev dependencies). List these packages with minimum versions matching pyproject.toml:
```
fastapi>=0.129.0
uvicorn[standard]>=0.40.0
pydantic>=2.12.5
pydantic-settings>=2.13.0
sse-starlette>=2.0
rdkit>=2025.9.4
```

Do NOT use `poetry export` -- it may include dev deps or produce overly pinned versions. Write the file manually with the >= constraints matching pyproject.toml.

3. Add `.env` and `.env.local` to the root `.gitignore` file (append two lines). The `.env.production` file IS committed (Vite convention), but local env files with secrets must NOT be. Also add `backend/.env` to ensure backend local env files stay out of git. The `.gitignore` already ignores `*.local` which covers `.env.local`, but explicitly adding `.env` patterns is safer.
  </action>
  <verify>
- `cat backend/requirements.txt` shows 6 packages (fastapi, uvicorn, pydantic, pydantic-settings, sse-starlette, rdkit)
- `grep rdkit backend/pyproject.toml` shows rdkit dependency
- `grep -c "env" .gitignore` shows env patterns added
  </verify>
  <done>backend/requirements.txt exists with all 6 production dependencies. pyproject.toml declares rdkit. .gitignore excludes .env files.</done>
</task>

<task type="auto">
  <name>Task 2: Add VITE_API_URL support to frontend and GitHub Actions workflow</name>
  <files>src/api/client.ts, src/api/sse.ts, .env.production, .github/workflows/deploy.yml</files>
  <action>
1. Create `.env.production` at repo root with placeholder URL (will be updated after Render service is created):
```
VITE_API_URL=https://webfaulon-backend.onrender.com
```
Note: This placeholder will be replaced with the actual Render URL once the service is created in Plan 02. Using a realistic placeholder now so the build pipeline is testable.

2. Update `src/api/client.ts` -- change the `baseURL` property in the `SAAPIClient` class:

BEFORE:
```typescript
private baseURL = '/api/sa';
```

AFTER:
```typescript
private baseURL = import.meta.env.VITE_API_URL
    ? `${import.meta.env.VITE_API_URL}/api/sa`
    : '/api/sa';
```

This way: in production (VITE_API_URL set), requests go to the full Render URL. In development (VITE_API_URL unset), requests go to `/api/sa` which hits the Vite proxy to localhost:8000.

3. Update `src/api/sse.ts` -- in the `connect` method, update the EventSource URL construction:

BEFORE:
```typescript
this.eventSource = new EventSource(`/api/sa/${sessionId}/stream`);
```

AFTER:
```typescript
const apiBase = import.meta.env.VITE_API_URL || '';
this.eventSource = new EventSource(`${apiBase}/api/sa/${sessionId}/stream`);
```

Same pattern: production uses full URL, dev uses relative path for Vite proxy.

4. Ensure the GitHub Actions deploy workflow will pick up `.env.production` automatically. Vite reads `.env.production` during `npm run build` when NODE_ENV=production (which is the default for `vite build`). No explicit changes needed to the workflow -- Vite handles this automatically. However, verify the workflow does NOT set a conflicting VITE_API_URL environment variable.

The existing workflow (`npm run build`) will automatically read `.env.production` from the repo root since Vite loads mode-specific env files. No workflow changes needed.
  </action>
  <verify>
- `grep "VITE_API_URL" src/api/client.ts` shows environment-driven URL
- `grep "VITE_API_URL" src/api/sse.ts` shows environment-driven URL
- `cat .env.production` shows VITE_API_URL with Render URL
- `npm run build` succeeds (from repo root) and `grep -r "onrender" dist/` shows URL injected in bundle
  </verify>
  <done>Frontend API client and SSE wrapper read VITE_API_URL at build time. .env.production has placeholder Render URL. Production build injects the backend URL into the JavaScript bundle.</done>
</task>

</tasks>

<verification>
1. `cat backend/requirements.txt` -- all 6 production deps listed
2. `grep "import.meta.env.VITE_API_URL" src/api/client.ts src/api/sse.ts` -- both files use env variable
3. `npm run build && grep -r "onrender.com" dist/` -- production URL embedded in build output
4. Run dev server: `npm run dev` -- Vite proxy still routes `/api` to localhost:8000 (dev workflow unbroken)
</verification>

<success_criteria>
- backend/requirements.txt is a valid pip requirements file with all 6 production dependencies
- .env.production contains VITE_API_URL pointing to Render backend
- src/api/client.ts and src/api/sse.ts use import.meta.env.VITE_API_URL with fallback to relative URL
- Production build (npm run build) injects the backend URL into the JavaScript bundle
- Development workflow (npm run dev with Vite proxy) still works unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment-production/08-01-SUMMARY.md`
</output>
