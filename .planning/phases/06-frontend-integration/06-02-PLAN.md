---
phase: 06-frontend-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/ui/app.ts
  - src/main.ts
  - index.html
autonomous: false

must_haves:
  truths:
    - "User can enter a formula, select a preset, adjust SA parameters, and click Start -- full workflow works end-to-end via backend API"
    - "Live chart updates from SSE progress events with same responsiveness as v1.0"
    - "Best molecule renders as SVG received from backend (no RDKit.js WASM in browser)"
    - "Start, pause, resume, and reset buttons work correctly during an active SA run"
    - "Progress bar, step counter, temperature, and energy stats update in real time"
    - "RDKit.js script tag and WASM loading are removed from index.html"
  artifacts:
    - path: "src/ui/app.ts"
      provides: "Alpine.js app component using backend API + SSE instead of Web Worker"
      contains: "SAAPIClient"
    - path: "src/main.ts"
      provides: "Alpine entry point (unchanged structure)"
      contains: "Alpine.start"
    - path: "index.html"
      provides: "HTML shell with SVG div replacing canvas, no RDKit.js script tag"
      contains: "molecule-display"
  key_links:
    - from: "src/ui/app.ts"
      to: "src/api/client.ts"
      via: "import SAAPIClient"
      pattern: "import.*SAAPIClient.*client"
    - from: "src/ui/app.ts"
      to: "src/api/sse.ts"
      via: "import SSEConnection"
      pattern: "import.*SSEConnection.*sse"
    - from: "src/ui/app.ts"
      to: "src/ui/molecule-renderer.ts"
      via: "import renderMoleculeSVG, clearMoleculeDisplay"
      pattern: "import.*renderMoleculeSVG.*molecule-renderer"
    - from: "src/ui/app.ts"
      to: "src/ui/chart.ts"
      via: "import addChartDataPoint, resetChart, createWienerChart"
      pattern: "import.*addChartDataPoint.*chart"
    - from: "index.html"
      to: "src/main.ts"
      via: "script type=module src"
      pattern: "script.*module.*main.ts"
---

<objective>
Rewire the Alpine.js app component from Web Worker + Comlink to backend REST API + SSE, and update the HTML to use SVG display instead of RDKit.js canvas rendering.

Purpose: Complete the frontend integration so the entire v1.0 UX (formula input, presets, parameter controls, start/pause/reset, live chart, molecule display) works via the Python backend API. This is the culmination of v2.0 Phases 4-6.

Output: Rewritten app.ts, updated index.html, unchanged main.ts structure. End-to-end functional frontend.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@src/ui/app.ts
@src/main.ts
@index.html
@src/api/types.ts
@src/api/client.ts
@src/api/sse.ts
@src/ui/molecule-renderer.ts
@src/ui/chart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite app.ts for backend API + SSE and update index.html</name>
  <files>src/ui/app.ts, index.html, src/main.ts</files>
  <action>
**src/ui/app.ts** -- Complete rewrite replacing Web Worker + Comlink with backend API + SSE:

Remove ALL Comlink and Worker code:
- Remove `import * as Comlink from 'comlink'`
- Remove `import type { ISAWorker, SAProgressData } from '../worker/types'`
- Remove `import type { SAParams, SAResult } from '../core/types'`
- Remove `import { renderMolecule, clearMoleculeCanvas } from './molecule-renderer'`
- Remove `_rawWorker`, `_saWorker` module-level variables
- Remove `createWorker()` and `destroyWorker()` functions

Add new imports:
- `import { SAAPIClient } from '../api/client'`
- `import { SSEConnection } from '../api/sse'`
- `import type { SSEProgressData, SSECompleteData } from '../api/types'`
- `import { createWienerChart, addChartDataPoint, resetChart } from './chart'` (keep)
- `import { renderMoleculeSVG, clearMoleculeDisplay } from './molecule-renderer'` (new names)
- `import { validateFormula, type ValidationResult } from './validation'` (keep)
- `import { PRESET_MOLECULES } from './presets'` (keep)

Create module-level instances OUTSIDE Alpine reactive scope (same pattern as v1.0 worker refs):
```typescript
const apiClient = new SAAPIClient();
const sseConnection = new SSEConnection();
```

Rewrite `appComponent()` return object:

**Keep unchanged:**
- Formula input state: `formula`, `validation`, `selectedPreset`, `presets`
- SA parameters: `initialTemp`, `coolingScheduleK`, `stepsPerCycle`, `numCycles`, `optimizationMode`
- Computed: `canStart`, `canPause`, `canResume`, `totalSteps`, `progressPercent`
- Methods: `selectPreset()`, `validateInput()`

**Modify state:**
- Add `sessionId: null as string | null` (backend session ID)
- Change `progress` type to `SSEProgressData | null` (different field names: snake_case)
- Change `result` type to `SSECompleteData | null`
- Remove `_prevBestEnergy` (no longer needed -- SVG comes with every progress event)
- Keep `bestSMILES: '' as string`
- Remove `rdkitReady: false` and `rdkitError: ''` (no more WASM loading)
- Add `backendError: '' as string` (for API/connection errors)

**Update computed properties:**
- `progressPercent`: change from `this.progress.step / this.progress.totalSteps` to use snake_case: `this.progress.step / this.progress.total_steps`
- Remove `canResume` references to worker state; keep simple: `return this.state === 'paused'`

**Rewrite init():**
- Remove ALL RDKit.js initialization (no `initRDKitModule`, no smoke test, no `window.__rdkit`)
- Keep chart initialization via `queueMicrotask`:
  ```typescript
  queueMicrotask(() => {
    const chartCanvas = document.getElementById('wiener-chart') as HTMLCanvasElement;
    if (chartCanvas) {
      createWienerChart(chartCanvas);
    }
    // Initialize molecule display placeholder
    const molDisplay = document.getElementById('molecule-display');
    if (molDisplay) {
      clearMoleculeDisplay(molDisplay);
    }
  });
  ```

**Add destroy():**
```typescript
destroy() {
  sseConnection.close();
}
```

**Rewrite start():**
```typescript
async start() {
  if (!this.validation.valid) return;

  try {
    this.backendError = '';

    // 1. Configure session via REST API
    const configResponse = await apiClient.configure({
      formula: this.formula,
      initial_temp: this.initialTemp,
      cooling_schedule_k: this.coolingScheduleK,
      steps_per_cycle: this.stepsPerCycle,
      num_cycles: this.numCycles,
      optimization_mode: this.optimizationMode,
      seed: Date.now(),
    });
    this.sessionId = configResponse.session_id;

    // 2. Start SA execution via REST API
    await apiClient.start(this.sessionId);

    // 3. Reset chart for new run
    resetChart();

    // 4. Connect SSE for real-time progress
    const self = this;
    sseConnection.connect(this.sessionId, {
      onProgress(data: SSEProgressData) {
        self.progress = data;
        addChartDataPoint(data.step, data.best_energy);

        // Update molecule SVG
        const molDisplay = document.getElementById('molecule-display');
        if (molDisplay && data.best_svg) {
          renderMoleculeSVG(data.best_svg, molDisplay);
        }

        // Track best SMILES
        if (data.best_smiles) {
          self.bestSMILES = data.best_smiles;
        }
      },
      onComplete(data: SSECompleteData) {
        self.state = 'complete';
        self.result = data;

        // Render final molecule
        const molDisplay = document.getElementById('molecule-display');
        if (molDisplay && data.best_svg) {
          renderMoleculeSVG(data.best_svg, molDisplay);
        }
        if (data.best_smiles) {
          self.bestSMILES = data.best_smiles;
        }
      },
      onError(_event: Event) {
        console.error('SSE connection error');
        // Attempt to re-sync state from backend
        self.resyncState();
      },
    });

    this.state = 'running';
    this.progress = null;
    this.result = null;
  } catch (e: unknown) {
    console.error('Start failed:', e);
    this.backendError = e instanceof Error ? e.message : 'Failed to start SA';
    this.state = 'idle';
  }
}
```

**Rewrite pause():**
```typescript
async pause() {
  if (!this.sessionId || this.state !== 'running') return;
  try {
    await apiClient.pause(this.sessionId);
    this.state = 'paused';
  } catch (e: unknown) {
    console.error('Pause failed:', e);
  }
}
```

**Rewrite resume():**
```typescript
async resume() {
  if (!this.sessionId || this.state !== 'paused') return;
  try {
    await apiClient.start(this.sessionId);  // Backend treats start on paused session as resume
    this.state = 'running';
  } catch (e: unknown) {
    console.error('Resume failed:', e);
  }
}
```

**Rewrite reset():**
```typescript
async reset() {
  sseConnection.close();  // Stop SSE first
  if (this.sessionId) {
    try {
      await apiClient.reset(this.sessionId);
    } catch (e: unknown) {
      console.error('Reset failed:', e);
    }
  }
  resetChart();
  const molDisplay = document.getElementById('molecule-display');
  if (molDisplay) {
    clearMoleculeDisplay(molDisplay);
  }
  this.state = 'idle';
  this.progress = null;
  this.result = null;
  this.sessionId = null;
  this.bestSMILES = '';
  this.backendError = '';
}
```

**Add resyncState():**
```typescript
async resyncState() {
  if (!this.sessionId) return;
  try {
    const status = await apiClient.getStatus(this.sessionId);
    this.state = status.session_state as any;
  } catch (e: unknown) {
    console.error('State resync failed:', e);
  }
}
```

**index.html** -- Update HTML to match new rendering approach:

1. Remove the RDKit.js script tag (line ~619):
   Delete: `<script src="https://unpkg.com/@rdkit/rdkit@2025.3.4-1.0.0/dist/RDKit_minimal.js"></script>`

2. Replace the molecule canvas with an SVG container:
   Change the `molecule-canvas-wrapper` div contents from:
   ```html
   <canvas id="molecule-canvas" width="400" height="400"></canvas>
   ```
   to:
   ```html
   <div id="molecule-display" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
   ```

3. Update the `#molecule-canvas` CSS rule to target `#molecule-display`:
   Replace `#molecule-canvas` selector with `#molecule-display` and adjust:
   ```css
   #molecule-display {
     max-width: 100%;
     min-height: 250px;
   }
   ```
   Also update `.molecule-canvas-wrapper` to just `.molecule-display-wrapper` if preferred, BUT keep the existing class name to minimize CSS churn -- just update the inner element.

4. Update progress data references from camelCase to snake_case in the HTML template:
   - `progress?.step` stays `progress?.step` (same)
   - `progress?.totalSteps` becomes `progress?.total_steps`
   - `progress?.temperature` stays `progress?.temperature` (same)
   - `progress?.currentEnergy` becomes `progress?.current_energy`
   - `progress?.bestEnergy` becomes `progress?.best_energy`

5. Update the Results section data references:
   - `result?.bestEnergy` becomes `result?.best_energy`
   - `result?.initialEnergy` -- removed (SSECompleteData doesn't have this field; remove this result-item entirely)
   - `result?.acceptedMoves` becomes `result?.accepted_moves`
   - `result?.rejectedMoves` becomes `result?.rejected_moves`
   - `result?.invalidMoves` becomes `result?.invalid_moves`
   - `result?.acceptanceRatio` -- computed: show `result ? (result.accepted_moves / (result.accepted_moves + result.rejected_moves) * 100).toFixed(1) + '%' : '-'`

6. Replace RDKit status section in footer:
   Instead of "RDKit.js WASM loaded" / "Loading RDKit.js WASM...", show backend connection status:
   ```html
   <p x-show="backendError" x-text="'Backend error: ' + backendError" class="error-text"></p>
   <p x-show="!backendError" class="hint">Backend: localhost:8000</p>
   ```

7. Remove the `molecule-canvas-wrapper` CSS `max-height` constraint -- SVGs scale naturally via viewBox and the container will size properly.

**src/main.ts** -- Keep as-is. The entry point registers `app` component via `Alpine.data('app', appComponent)` and calls `Alpine.start()`. No changes needed. Verify it still imports from `./ui/app`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes -- all files compile with new imports and types.
2. `npx vite build` succeeds -- production build completes without errors.
3. Grep confirms zero remaining references to: `Comlink`, `_saWorker`, `_rawWorker`, `ISAWorker`, `RDKit`, `initRDKitModule`, `molecule-canvas`, `rdkitReady`, `rdkitError`, `bestMolBlock`, `renderMolecule`, `clearMoleculeCanvas` in src/ui/app.ts.
4. Grep confirms index.html has no `unpkg.com/@rdkit` script tag.
5. Grep confirms index.html uses `molecule-display` (div) not `molecule-canvas` (canvas).
  </verify>
  <done>
app.ts uses SAAPIClient + SSEConnection instead of Comlink + Worker. index.html has SVG div instead of canvas, no RDKit script tag. All progress/result data uses snake_case matching backend JSON. TypeScript compiles, Vite builds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end SA workflow via backend</name>
  <what-built>Complete frontend integration: Alpine.js app communicates with Python backend via REST API + SSE. Formula input, presets, SA parameters, start/pause/reset buttons, live chart, and molecule SVG display -- all working through the backend.</what-built>
  <how-to-verify>
1. Start the backend: `cd backend && python -m uvicorn app.main:app --reload`
2. In another terminal, start the frontend: `npx vite dev` (should show "Local: http://localhost:5173/webfaulon/")
3. Open http://localhost:5173/webfaulon/ in browser

**Test 1 - Basic workflow:**
- Select "Hexane isomers (C6H14)" from Quick Start dropdown
- Click Start
- Verify: Progress bar fills, chart updates with Wiener Index data points, molecule SVG appears
- Wait for completion. Verify: Results section shows best energy, accepted/rejected/invalid moves

**Test 2 - Pause/Resume:**
- Select "Decane isomers (C10H22)" (longer run)
- Click Start
- While running, click Pause -- verify chart stops updating
- Click Resume -- verify chart resumes updating
- Wait for completion

**Test 3 - Reset:**
- Start any run, then click Reset while running
- Verify: Chart clears, molecule display shows "No structure yet", state returns to idle

**Test 4 - SVG rendering:**
- During any run, verify the molecule display shows an actual molecular structure SVG (not a blank box or error)
- The SVG should update as better molecules are found

**Test 5 - No RDKit.js WASM:**
- Open browser DevTools Network tab
- Confirm NO requests to unpkg.com/@rdkit or any .wasm files
- The molecule rendering is pure SVG from the backend
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 tests pass, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` succeeds
2. `npx vite build` succeeds
3. No references to Comlink, Web Worker, RDKit.js WASM, or canvas rendering in app.ts
4. No RDKit script tag in index.html
5. index.html uses `#molecule-display` div (not canvas)
6. All snake_case data bindings in HTML match backend JSON structure
7. Backend API called via REST (configure, start, pause, reset, status)
8. SSE events drive live chart and molecule updates
9. End-to-end workflow verified by human (checkpoint)
</verification>

<success_criteria>
- User completes full SA workflow (enter formula -> start -> view results) via backend API
- Live chart updates from SSE events match v1.0 responsiveness
- Molecule displays as backend-generated SVG (zero RDKit.js WASM in browser)
- Pause, resume, reset controls work during active SA run
- Human verification confirms all 5 test scenarios pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-02-SUMMARY.md`
</output>
