---
phase: 06-frontend-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/types.ts
  - src/api/client.ts
  - src/api/sse.ts
  - src/ui/molecule-renderer.ts
  - vite.config.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match backend Pydantic models exactly (snake_case field names)"
    - "REST API client can call configure, start, pause, reset, and getStatus endpoints"
    - "SSE wrapper connects to stream endpoint and dispatches typed progress/complete/error events"
    - "SSE wrapper closes connection cleanly (no leaked EventSource)"
    - "Molecule renderer displays raw SVG via innerHTML (no RDKit.js WASM)"
    - "Vite dev server proxies /api requests to localhost:8000"
  artifacts:
    - path: "src/api/types.ts"
      provides: "TypeScript interfaces mirroring backend Pydantic models"
      contains: "SAParams"
    - path: "src/api/client.ts"
      provides: "Typed REST API client for SA endpoints"
      exports: ["SAAPIClient"]
    - path: "src/api/sse.ts"
      provides: "SSE EventSource wrapper with typed handlers and cleanup"
      exports: ["SSEConnection"]
    - path: "src/ui/molecule-renderer.ts"
      provides: "SVG innerHTML renderer replacing RDKit.js canvas renderer"
      exports: ["renderMoleculeSVG", "clearMoleculeDisplay"]
    - path: "vite.config.ts"
      provides: "Dev proxy for /api to backend"
      contains: "proxy"
  key_links:
    - from: "src/api/client.ts"
      to: "src/api/types.ts"
      via: "import type"
      pattern: "import.*types"
    - from: "src/api/sse.ts"
      to: "src/api/types.ts"
      via: "import type for SSE event data"
      pattern: "import.*types"
    - from: "src/api/client.ts"
      to: "/api/sa/"
      via: "fetch calls to backend REST endpoints"
      pattern: "fetch.*api/sa"
---

<objective>
Create the API client infrastructure and SVG renderer that the frontend needs to communicate with the Python backend.

Purpose: Establish the typed communication layer (REST client + SSE wrapper + TypeScript types) and the SVG molecule renderer, so that Plan 02 can rewire app.ts from Web Worker to backend API with no ambiguity about the API contract.

Output: 5 files -- 3 new API modules (types, client, SSE), 1 rewritten molecule renderer, 1 updated Vite config.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md
@.planning/phases/05-api-layer-sse-streaming/05-02-SUMMARY.md
@.planning/phases/05-api-layer-sse-streaming/05-03-SUMMARY.md
@backend/app/models/sa_params.py
@backend/app/api/sa_configure.py
@backend/app/api/sa_control.py
@backend/app/api/sa_status.py
@backend/app/api/sa_stream.py
@src/ui/molecule-renderer.ts
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API types, REST client, and SSE wrapper</name>
  <files>src/api/types.ts, src/api/client.ts, src/api/sse.ts</files>
  <action>
Create three new files in `src/api/`:

**src/api/types.ts** -- TypeScript interfaces mirroring backend Pydantic models EXACTLY (use snake_case to match JSON):

1. `SAConfigParams` -- mirrors `backend/app/models/sa_params.py::SAParams`:
   - `formula: string`
   - `initial_temp: number`
   - `cooling_schedule_k: number`
   - `steps_per_cycle: number`
   - `num_cycles: number`
   - `optimization_mode: 'MINIMIZE' | 'MAXIMIZE'`
   - `seed: number`

2. `ConfigureResponse` -- mirrors `sa_configure.py::ConfigureResponse`:
   - `session_id: string`
   - `status: string`

3. `ControlResponse` -- mirrors `sa_control.py::ControlResponse`:
   - `session_id: string`
   - `status: string`

4. `StatusResponse` -- mirrors `sa_status.py::StatusResponse`:
   - `session_id: string`
   - `session_state: string`
   - `step: number`
   - `total_steps: number`
   - `cycle: number`
   - `current_energy: number`
   - `best_energy: number`
   - `best_smiles: string`
   - `best_svg: string`
   - `temperature: number`
   - `accepted_moves: number`
   - `rejected_moves: number`
   - `invalid_moves: number`
   - `is_complete: boolean`

5. `SSEProgressData` -- mirrors the JSON `data` field of "progress" SSE events (see `sa_stream.py` lines 84-97):
   - `step: number`
   - `total_steps: number`
   - `cycle: number`
   - `temperature: number`
   - `current_energy: number`
   - `best_energy: number`
   - `best_smiles: string`
   - `best_svg: string`
   - `accepted_moves: number`
   - `rejected_moves: number`
   - `invalid_moves: number`
   - `is_complete: boolean`

6. `SSECompleteData` -- mirrors the JSON `data` field of "complete" SSE events (see `sa_stream.py` lines 60-70):
   - `step: number`
   - `total_steps: number`
   - `best_energy: number`
   - `best_smiles: string`
   - `best_svg: string`
   - `accepted_moves: number`
   - `rejected_moves: number`
   - `invalid_moves: number`

7. `SSEWaitingData` -- mirrors "waiting" event:
   - `session_state: string`
   - `message: string`

8. `SSEErrorData` -- mirrors "error" event:
   - `error: string`

Comment each interface with the backend source file it mirrors for traceability.

**src/api/client.ts** -- Typed REST API client class:

Class `SAAPIClient` with:
- Private `baseURL = '/api/sa'` (Vite proxies to backend in dev)
- `async configure(params: SAConfigParams): Promise<ConfigureResponse>` -- POST /api/sa/configure with JSON body
- `async start(sessionId: string): Promise<ControlResponse>` -- POST /api/sa/{sessionId}/start
- `async pause(sessionId: string): Promise<ControlResponse>` -- POST /api/sa/{sessionId}/pause
- `async reset(sessionId: string): Promise<ControlResponse>` -- POST /api/sa/{sessionId}/reset
- `async getStatus(sessionId: string): Promise<StatusResponse>` -- GET /api/sa/{sessionId}/status
- Private helper `async controlRequest(sessionId: string, action: string): Promise<ControlResponse>` to DRY up start/pause/reset

Error handling: On non-OK response, attempt to parse JSON error body. Throw `Error` with message from `error.detail` or `error.error` field, falling back to `HTTP {status}: {action} failed`.

**src/api/sse.ts** -- SSE EventSource wrapper:

Class `SSEConnection` with:
- Private `eventSource: EventSource | null = null`
- `connect(sessionId: string, handlers: SSEHandlers): void` where `SSEHandlers` is:
  ```typescript
  interface SSEHandlers {
    onProgress?: (data: SSEProgressData) => void;
    onComplete?: (data: SSECompleteData) => void;
    onWaiting?: (data: SSEWaitingData) => void;
    onError?: (event: Event) => void;
  }
  ```
  The `connect` method:
  1. Calls `this.close()` first to clean up any existing connection
  2. Creates `new EventSource('/api/sa/${sessionId}/stream')`
  3. Adds typed `addEventListener` for 'progress', 'complete', 'waiting' events -- each calls `JSON.parse(e.data)` and dispatches to the corresponding handler
  4. Sets `onerror` handler that calls `handlers.onError` if provided
  5. On 'complete' event, auto-calls `this.close()` after dispatching handler

- `close(): void` -- Calls `eventSource.close()` if not null, sets to null
- `isConnected(): boolean` -- Returns `eventSource?.readyState === EventSource.OPEN`

Export both `SSEConnection` class and `SSEHandlers` interface.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. All three files should compile without errors. Verify no import errors by checking that types.ts exports are correctly consumed by client.ts and sse.ts.
  </verify>
  <done>
Three files exist: src/api/types.ts with 8 interfaces matching backend models, src/api/client.ts with SAAPIClient class covering all 5 endpoints, src/api/sse.ts with SSEConnection class handling all 4 SSE event types. TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite molecule renderer for SVG and add Vite proxy</name>
  <files>src/ui/molecule-renderer.ts, vite.config.ts</files>
  <action>
**src/ui/molecule-renderer.ts** -- Complete rewrite replacing RDKit.js canvas rendering with backend SVG innerHTML rendering:

Replace the entire file with a new module that exports:

1. `renderMoleculeSVG(svg: string, container: HTMLElement): void`
   - Guard: if `!svg` or `!container`, return early
   - Set `container.innerHTML = svg` (browser parses SVG markup natively)
   - The backend RDKit generates safe SVG; no sanitization needed

2. `clearMoleculeDisplay(container: HTMLElement): void`
   - Guard: if `!container`, return early
   - Set `container.innerHTML` to a centered gray placeholder: a `<div>` with flex centering and a `<p>` saying "No structure yet" in color #9ca3af
   - Use inline styles for the centering (consistent with existing inline style patterns in index.html)

Remove all RDKit.js references:
- No `(window as any).__rdkit`
- No `mol.set_new_coords()`, `mol.draw_to_canvas()`, `mol.delete()`
- No `_lastRenderedMolBlock` tracking (SVG is idempotent via innerHTML)
- No canvas 2D context operations

The old exports `renderMolecule` and `clearMoleculeCanvas` are replaced by `renderMoleculeSVG` and `clearMoleculeDisplay`. Plan 02 will update app.ts to use the new function names.

**vite.config.ts** -- Add dev server proxy configuration:

Add a `server.proxy` section to the existing `defineConfig`:
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true,
    }
  }
},
```

This proxies all `/api/*` requests to the backend during development. No URL rewriting needed since the backend already serves at `/api/sa/*`.

Keep ALL existing config (base, resolve.alias, worker, build, optimizeDeps) unchanged.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm molecule-renderer.ts compiles.
2. Verify vite.config.ts is valid by running `npx vite build --mode development 2>&1 | head -5` (should not error on config parsing).
3. Inspect molecule-renderer.ts to confirm no RDKit imports or canvas references remain.
  </verify>
  <done>
molecule-renderer.ts exports renderMoleculeSVG and clearMoleculeDisplay using innerHTML (zero RDKit.js dependency). vite.config.ts has proxy config for /api -> localhost:8000. Both files compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors (all new files type-check)
2. `src/api/types.ts` contains interfaces with snake_case fields matching backend JSON exactly
3. `src/api/client.ts` exports SAAPIClient with methods for all 5 backend endpoints
4. `src/api/sse.ts` exports SSEConnection with typed handlers for progress, complete, waiting, error events
5. `src/ui/molecule-renderer.ts` contains zero references to RDKit, canvas, or WASM
6. `vite.config.ts` contains proxy configuration for /api -> localhost:8000
7. No existing files broken (validation.ts, presets.ts, chart.ts unchanged)
</verification>

<success_criteria>
- All 5 files exist and compile with `npx tsc --noEmit`
- API types use snake_case matching backend JSON (not camelCase)
- API client handles errors (non-OK responses throw with message)
- SSE wrapper auto-closes on 'complete' event
- Molecule renderer uses innerHTML (no canvas operations)
- Vite proxy enables /api -> localhost:8000 in dev
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-01-SUMMARY.md`
</output>
