---
phase: 04-backend-core-rdkit-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/app/__init__.py
  - backend/app/main.py
  - backend/app/config.py
  - backend/app/models/__init__.py
  - backend/app/models/errors.py
  - backend/app/core/__init__.py
  - backend/app/utils/__init__.py
  - backend/tests/__init__.py
  - backend/tests/conftest.py
  - backend/tests/test_app.py
  - backend/.env.example
autonomous: true
must_haves:
  truths:
    - "FastAPI server starts and /docs shows OpenAPI documentation"
    - "GET /health returns JSON with server status 200"
    - "Invalid endpoint returns structured JSON error with correct HTTP status code"
    - "CORS allows requests from localhost:5173 and steinbeck.github.io"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "Poetry project config with FastAPI, uvicorn, pydantic, pytest dependencies"
      contains: "fastapi"
    - path: "backend/app/main.py"
      provides: "FastAPI application with CORS, health endpoint, error handlers"
      exports: ["app"]
    - path: "backend/app/config.py"
      provides: "Pydantic settings for environment-based configuration"
      contains: "BaseSettings"
    - path: "backend/app/models/errors.py"
      provides: "Structured error response model"
      contains: "ErrorResponse"
    - path: "backend/tests/test_app.py"
      provides: "Tests for health check, CORS, error handling"
      min_lines: 30
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/config.py"
      via: "Settings import for CORS origins"
      pattern: "from app.config import"
    - from: "backend/tests/test_app.py"
      to: "backend/app/main.py"
      via: "TestClient fixture"
      pattern: "TestClient.*app"
---

<objective>
Create the Python backend project scaffold with FastAPI, including project setup (Poetry), the FastAPI application with CORS middleware, a health check endpoint, and structured JSON error responses.

Purpose: Establish the backend foundation that all subsequent plans build on. This is the skeleton that receives molecular computation modules.
Output: A running FastAPI server with /health endpoint, /docs OpenAPI page, CORS configured, and structured error handling.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-backend-core-rdkit-foundation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Poetry project scaffold and FastAPI application</name>
  <files>
    backend/pyproject.toml
    backend/app/__init__.py
    backend/app/main.py
    backend/app/config.py
    backend/app/models/__init__.py
    backend/app/models/errors.py
    backend/app/core/__init__.py
    backend/app/utils/__init__.py
    backend/.env.example
  </files>
  <action>
    Create the `backend/` directory at the project root (sibling to existing `src/`).

    1. Initialize Poetry project:
       - Run `cd backend && poetry init --name webfaulon-backend --python "^3.10" --no-interaction`
       - Run `poetry config virtualenvs.in-project true` (local .venv)
       - Add dependencies: `poetry add fastapi "uvicorn[standard]" pydantic pydantic-settings`
       - Add dev dependencies: `poetry add --group dev pytest pytest-asyncio pytest-cov httpx ruff`
       - Note: Do NOT add rdkit via poetry yet -- it will be installed via pip/conda separately in Plan 03.
       - Run `poetry install`

    2. Configure pyproject.toml tool sections:
       ```toml
       [tool.pytest.ini_options]
       testpaths = ["tests"]
       asyncio_mode = "auto"

       [tool.ruff]
       line-length = 100
       target-version = "py310"
       ```

    3. Create `backend/app/config.py`:
       - Pydantic `BaseSettings` class named `Settings`
       - Fields: `app_name: str = "WebFaulon"`, `debug: bool = False`, `allowed_origins: list[str]` with default `["http://localhost:5173", "http://127.0.0.1:5173", "https://steinbeck.github.io"]`
       - Use `model_config = SettingsConfigDict(env_file=".env", env_prefix="WEBFAULON_")` for env var loading

    4. Create `backend/app/models/errors.py`:
       - Pydantic model `ErrorResponse` with fields: `error: str`, `detail: str | None = None`, `status_code: int`
       - This model is used for all 4xx and 5xx error responses

    5. Create `backend/app/main.py`:
       - Import FastAPI, CORSMiddleware, Settings
       - Create `app = FastAPI(title="WebFaulon API", version="2.0.0")`
       - Add CORSMiddleware FIRST (before any other middleware) with origins from Settings
       - `allow_methods=["*"]`, `allow_headers=["*"]`, `allow_credentials=False` (no auth cookies needed)
       - Add exception handlers:
         - `RequestValidationError` -> 422 with ErrorResponse body
         - `HTTPException` -> preserve status code with ErrorResponse body
         - Generic `Exception` -> 500 with ErrorResponse body (hide details in non-debug mode)
       - Add `GET /health` endpoint returning `{"status": "healthy", "version": "2.0.0"}`

    6. Create `backend/.env.example` with:
       ```
       WEBFAULON_DEBUG=true
       WEBFAULON_ALLOWED_ORIGINS=["http://localhost:5173"]
       ```

    7. Create empty `__init__.py` files in: `app/`, `app/models/`, `app/core/`, `app/utils/`
  </action>
  <verify>
    Run from project root:
    ```
    cd backend && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    sleep 2
    curl -s http://localhost:8000/health | python3 -m json.tool
    curl -s http://localhost:8000/docs | head -5
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/nonexistent
    kill %1
    ```
    Health returns 200 with `{"status": "healthy", "version": "2.0.0"}`.
    /docs returns HTML (Swagger UI).
    /nonexistent returns 404.
  </verify>
  <done>
    FastAPI server starts successfully with `uvicorn app.main:app`.
    GET /health returns 200 with status JSON.
    GET /docs returns Swagger UI HTML.
    CORS headers present in responses for configured origins.
    404/422/500 errors return structured ErrorResponse JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: API tests for health, CORS, and error handling</name>
  <files>
    backend/tests/__init__.py
    backend/tests/conftest.py
    backend/tests/test_app.py
  </files>
  <action>
    1. Create `backend/tests/conftest.py`:
       - Import `pytest`, `httpx.AsyncClient` (or `from fastapi.testclient import TestClient`)
       - Create fixture `client` that returns `TestClient(app)` from `app.main`
       - Use synchronous TestClient (simpler, no need for async in this plan)

    2. Create `backend/tests/test_app.py` with these test cases:

       **Health endpoint (BACK-03):**
       - `test_health_returns_200`: GET /health returns 200
       - `test_health_response_body`: response contains `status` and `version` keys
       - `test_health_status_value`: `status` is "healthy"

       **CORS (BACK-02):**
       - `test_cors_allows_localhost_origin`: OPTIONS request with `Origin: http://localhost:5173` returns `access-control-allow-origin` header
       - `test_cors_allows_github_pages`: OPTIONS request with `Origin: https://steinbeck.github.io` returns correct header
       - `test_cors_blocks_unknown_origin`: OPTIONS request with `Origin: https://evil.com` does NOT return `access-control-allow-origin` header

       **Error handling (BACK-04):**
       - `test_404_returns_json_error`: GET to nonexistent path returns 404 with `ErrorResponse` JSON body (keys: `error`, `status_code`)
       - `test_error_response_structure`: verify ErrorResponse has required fields

       **OpenAPI (BACK-01):**
       - `test_docs_accessible`: GET /docs returns 200
       - `test_openapi_json_accessible`: GET /openapi.json returns 200 with valid JSON

    3. Run tests: `cd backend && poetry run pytest tests/ -v`
  </action>
  <verify>
    `cd backend && poetry run pytest tests/ -v` -- all tests pass.
  </verify>
  <done>
    All test cases pass. Health endpoint, CORS, error handling, and OpenAPI docs are verified by automated tests.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && poetry run uvicorn app.main:app --port 8000` starts without errors
2. `curl http://localhost:8000/health` returns `{"status": "healthy", "version": "2.0.0"}`
3. `curl http://localhost:8000/docs` returns Swagger UI HTML
4. `curl http://localhost:8000/openapi.json` returns valid OpenAPI JSON
5. `cd backend && poetry run pytest tests/ -v` -- all tests pass
6. CORS headers appear for allowed origins, absent for disallowed origins
</verification>

<success_criteria>
- FastAPI server starts and serves /docs with auto-generated OpenAPI documentation
- /health returns 200 with server status JSON
- Invalid requests return structured ErrorResponse JSON with correct HTTP status codes
- CORS middleware allows localhost:5173 and steinbeck.github.io origins
- All tests pass with `poetry run pytest`
</success_criteria>

<output>
After completion, create `.planning/phases/04-backend-core-rdkit-foundation/04-01-SUMMARY.md`
</output>
