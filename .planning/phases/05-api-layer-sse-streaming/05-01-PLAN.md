---
phase: 05-api-layer-sse-streaming
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/services/__init__.py
  - backend/app/services/session_manager.py
  - backend/app/services/svg_renderer.py
  - backend/tests/test_session_manager.py
  - backend/tests/test_svg_renderer.py
  - backend/pyproject.toml
  - backend/app/config.py
autonomous: true

must_haves:
  truths:
    - "SessionManager creates sessions from SAParams and returns unique session IDs"
    - "SessionManager retrieves sessions by ID, returning None for missing/expired sessions"
    - "SessionManager cleans up sessions that exceed TTL"
    - "SVG renderer generates valid SVG strings from SMILES input"
    - "SVG renderer handles invalid SMILES gracefully with ValueError"
    - "Session state transitions correctly (idle -> running -> paused -> idle via reset)"
  artifacts:
    - path: "backend/app/services/session_manager.py"
      provides: "Session CRUD with TTL expiration"
      exports: ["SessionManager", "SASession"]
    - path: "backend/app/services/svg_renderer.py"
      provides: "RDKit SVG molecule rendering"
      exports: ["generate_molecule_svg"]
    - path: "backend/tests/test_session_manager.py"
      provides: "SessionManager test coverage"
    - path: "backend/tests/test_svg_renderer.py"
      provides: "SVG renderer test coverage"
  key_links:
    - from: "backend/app/services/session_manager.py"
      to: "backend/app/core/sa_engine.py"
      via: "SAEngine instantiation in create()"
      pattern: "SAEngine\\(params\\)"
    - from: "backend/app/services/svg_renderer.py"
      to: "rdkit.Chem.Draw.rdMolDraw2D"
      via: "MolDraw2DSVG import"
      pattern: "MolDraw2DSVG"
---

<objective>
Implement SessionManager and SVG renderer services using TDD -- the foundation layer for all Phase 5 API endpoints.

Purpose: API endpoints need session lifecycle management (create, get, expire) and molecule SVG generation. Building these as tested services first ensures the API layer has reliable building blocks.

Output: Two tested service modules (SessionManager with TTL, SVG renderer with RDKit), plus sse-starlette dependency installed.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-api-layer-sse-streaming/05-RESEARCH.md
@.planning/phases/04-backend-core-rdkit-foundation/04-04-SUMMARY.md
@backend/app/core/sa_engine.py
@backend/app/models/sa_params.py
@backend/app/config.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionManager service with TDD</name>
  <files>
    backend/app/services/__init__.py
    backend/app/services/session_manager.py
    backend/tests/test_session_manager.py
    backend/pyproject.toml
    backend/app/config.py
  </files>
  <action>
**Install sse-starlette dependency first (needed by Plan 02/03):**
```bash
cd backend && pip install sse-starlette
```
Also add `sse-starlette = "^2.0"` to `[tool.poetry.dependencies]` in pyproject.toml.

**Add TTL setting to config.py:**
Add `session_ttl_seconds: int = 3600` to the Settings class (1-hour TTL default, configurable via WEBFAULON_SESSION_TTL_SECONDS env var).

**Create `backend/app/services/__init__.py`** (empty).

**RED phase -- Write tests first in `backend/tests/test_session_manager.py`:**

Test cases for SessionManager:

1. **Creation tests:**
   - `test_create_returns_uuid_string` -- create() returns a valid UUID string
   - `test_create_stores_session` -- after create(), get() returns the session
   - `test_create_initializes_engine` -- session.engine is initialized (get_state() works without error)
   - `test_create_sets_idle_state` -- session.state is "idle" after creation
   - `test_create_multiple_unique_ids` -- creating 3 sessions returns 3 different IDs

2. **Retrieval tests:**
   - `test_get_existing_session` -- returns SASession with correct session_id
   - `test_get_nonexistent_returns_none` -- returns None for unknown ID
   - `test_get_updates_last_accessed` -- accessing session updates last_accessed timestamp

3. **State management tests:**
   - `test_session_state_transitions` -- state can be set to "running", "paused", "idle"
   - `test_delete_session` -- delete() removes session, get() returns None after

4. **TTL cleanup tests:**
   - `test_cleanup_removes_expired` -- after manually setting last_accessed to past, cleanup_expired() removes session
   - `test_cleanup_keeps_active` -- recently accessed sessions survive cleanup
   - `test_active_session_count` -- active_session_count property returns correct count

**SessionManager implementation:**

```python
@dataclass
class SASession:
    session_id: str
    engine: SAEngine
    created_at: datetime
    last_accessed: datetime
    state: str  # "idle", "running", "paused", "complete"
```

SessionManager class:
- `__init__(self, ttl_seconds: int = 3600)` -- stores TTL as timedelta, creates empty dict
- `create(self, params: SAParams) -> str` -- creates SAEngine, calls engine.init(), stores SASession, returns UUID
- `get(self, session_id: str) -> Optional[SASession]` -- returns session or None, updates last_accessed
- `delete(self, session_id: str) -> bool` -- removes session, returns True if existed
- `cleanup_expired(self) -> int` -- removes expired sessions, returns count removed
- `active_session_count` property -- returns len of sessions dict

Use `uuid.uuid4()` for session IDs. Use `datetime.now()` for timestamps.

**GREEN phase:** Implement minimally to pass all tests.

**REFACTOR if needed:** Clean up types, add docstrings.
  </action>
  <verify>
```bash
cd /Users/steinbeck/Dropbox/develop/webfaulon/backend && python -m pytest tests/test_session_manager.py -v
```
All tests pass. SessionManager creates, retrieves, deletes, and expires sessions correctly.
  </verify>
  <done>SessionManager creates sessions from SAParams, retrieves by ID (with last_accessed update), deletes sessions, and cleans up expired sessions based on TTL. All 13 test cases pass.</done>
</task>

<task type="auto">
  <name>Task 2: SVG renderer service with TDD</name>
  <files>
    backend/app/services/svg_renderer.py
    backend/tests/test_svg_renderer.py
  </files>
  <action>
**RED phase -- Write tests first in `backend/tests/test_svg_renderer.py`:**

Test cases for generate_molecule_svg():

1. **Valid SMILES tests:**
   - `test_generates_svg_from_valid_smiles` -- "CCCCCC" returns string containing "<svg" and "</svg>"
   - `test_svg_contains_drawing_elements` -- SVG contains path or line elements (not empty canvas)
   - `test_custom_dimensions` -- generate_molecule_svg("CCCCCC", width=400, height=400) returns SVG with specified dimensions
   - `test_default_dimensions` -- default 300x300 when no width/height provided
   - `test_aromatic_smiles` -- "c1ccccc1" (benzene) produces valid SVG
   - `test_branched_molecule` -- "CC(C)CC" produces valid SVG

2. **Error handling tests:**
   - `test_invalid_smiles_raises_valueerror` -- "INVALID" raises ValueError
   - `test_empty_smiles_raises_valueerror` -- "" raises ValueError

3. **Performance test:**
   - `test_svg_generation_under_50ms` -- generating SVG for "CCCCCC" takes < 50ms (sanity check for SSE streaming)

**SVG renderer implementation in `backend/app/services/svg_renderer.py`:**

```python
from rdkit import Chem
from rdkit.Chem.Draw import rdMolDraw2D

def generate_molecule_svg(smiles: str, width: int = 300, height: int = 300) -> str:
    """Generate 2D SVG depiction of molecule from SMILES.

    Args:
        smiles: SMILES notation string
        width: SVG width in pixels (default 300)
        height: SVG height in pixels (default 300)

    Returns:
        SVG string (inline, embeddable in HTML or SSE events)

    Raises:
        ValueError: If SMILES is invalid or empty
    """
    if not smiles:
        raise ValueError("Empty SMILES string")

    mol = Chem.MolFromSmiles(smiles)
    if mol is None:
        raise ValueError(f"Invalid SMILES: {smiles}")

    drawer = rdMolDraw2D.MolDraw2DSVG(width, height)
    rdMolDraw2D.PrepareAndDrawMolecule(drawer, mol)
    drawer.FinishDrawing()

    return drawer.GetDrawingText()
```

**GREEN phase:** Run tests, ensure all pass.

**REFACTOR if needed:** The implementation is straightforward; refactor only if tests reveal edge cases.
  </action>
  <verify>
```bash
cd /Users/steinbeck/Dropbox/develop/webfaulon/backend && python -m pytest tests/test_svg_renderer.py -v
```
All tests pass. SVG renderer generates valid SVGs from SMILES, handles errors correctly, and runs under 50ms.

Also run full test suite to ensure no regressions:
```bash
cd /Users/steinbeck/Dropbox/develop/webfaulon/backend && python -m pytest tests/ -v
```
  </verify>
  <done>SVG renderer generates valid inline SVG strings from SMILES using RDKit MolDraw2DSVG. Handles invalid/empty SMILES with ValueError. Performance verified under 50ms. All 9 new tests pass, full suite passes with no regressions.</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/test_session_manager.py tests/test_svg_renderer.py -v` -- all ~22 tests pass
2. `cd backend && python -m pytest tests/ -v` -- full suite passes (146 existing + ~22 new = ~168 total)
3. `python -c "from app.services.session_manager import SessionManager; print('SessionManager importable')"` -- imports cleanly
4. `python -c "from app.services.svg_renderer import generate_molecule_svg; svg = generate_molecule_svg('CCCCCC'); print(f'SVG length: {len(svg)}, has svg tag: {\"<svg\" in svg}')"` -- generates valid SVG
5. `pip show sse-starlette` -- sse-starlette 2.x installed
</verification>

<success_criteria>
- SessionManager creates, retrieves, deletes, and expires sessions with TTL
- SVG renderer produces valid inline SVG from SMILES strings
- All new tests pass, full test suite has no regressions
- sse-starlette dependency installed and available
- Session TTL is configurable via Settings
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-layer-sse-streaming/05-01-SUMMARY.md`
</output>
