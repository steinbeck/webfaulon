---
phase: 06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo
plan: 02
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - backend/tests/test_displacement.py
  - backend/tests/test_sa_engine.py
autonomous: true

must_haves:
  truths:
    - "Displacement on kekulized benzene succeeds with >= 85% success rate over 500 attempts"
    - "Displacement on kekulized naphthalene succeeds with >= 40% success rate over 500 attempts"
    - "Full SA optimization on C6H6 completes without crashing and produces valid SMILES"
    - "Full SA optimization on C10H8 completes without crashing and produces valid SMILES"
    - "All preset molecule formulas (C6H14, C8H18, C8H10, C10H22, C10H16, C10H8) run through SA without errors"
    - "Existing displacement and SA engine tests still pass"
  artifacts:
    - path: "backend/tests/test_displacement.py"
      provides: "Benzene and naphthalene displacement tests + success rate benchmarks"
      contains: "TestBenzeneDisplacement"
    - path: "backend/tests/test_sa_engine.py"
      provides: "SA engine integration tests for unsaturated molecules and all preset formulas"
      contains: "TestUnsaturatedMolecules"
  key_links:
    - from: "backend/tests/test_displacement.py"
      to: "backend/app/core/displacement.py"
      via: "import attempt_displacement"
      pattern: "from app.core.displacement import attempt_displacement"
    - from: "backend/tests/test_sa_engine.py"
      to: "backend/app/core/sa_engine.py"
      via: "import SAEngine"
      pattern: "from app.core.sa_engine import SAEngine"
---

<objective>
Add integration-level tests verifying that displacement and full SA optimization work correctly on unsaturated/aromatic molecules. Benchmark displacement success rates and verify all frontend preset molecules run end-to-end.

Purpose: Plan 01 fixed the core aromaticity bug at the unit level. This plan verifies the fix propagates correctly through the displacement algorithm and SA engine, and that all 6 preset molecules from the frontend work without errors.

Output: Displacement benchmark tests for benzene/naphthalene, SA engine integration tests for all unsaturated presets.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-RESEARCH.md
@.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-01-SUMMARY.md
@backend/app/core/displacement.py
@backend/app/core/sa_engine.py
@backend/app/core/initial_structure.py
@backend/tests/test_displacement.py
@backend/tests/test_sa_engine.py
@src/ui/presets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aromatic molecule displacement tests and benchmarks</name>
  <files>backend/tests/test_displacement.py</files>
  <action>
Add two new test classes to the existing test_displacement.py file.

**Class 1: TestBenzeneDisplacement** (after TestCyclohexaneDisplacement)

```python
class TestBenzeneDisplacement:
    """Test displacement on benzene (kekulized aromatic)"""

    def test_benzene_displacement_does_not_crash(self):
        """Benzene displacement produces results without AROMATIC error"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccccc1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(42)

        # Should not raise "Cannot map bond type AROMATIC"
        for _ in range(100):
            result = attempt_displacement(graph, rng)
            if result is not None:
                assert result.is_connected()
                assert result.has_valid_valences()

    def test_benzene_displacement_success_rate(self):
        """Benzene displacement succeeds >= 85% of 500 attempts"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccccc1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(42)

        successes = sum(1 for _ in range(500) if attempt_displacement(graph, rng) is not None)
        success_rate = successes / 500

        assert success_rate >= 0.85, \
            f"Benzene displacement success rate {success_rate:.1%} below 85% minimum"

    def test_benzene_preserves_atom_count(self):
        """Benzene displacement preserves 6 atoms"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccccc1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(777)

        for _ in range(100):
            result = attempt_displacement(graph, rng)
            if result is not None:
                assert result.get_atom_count() == 6
```

**Class 2: TestNaphthaleneDisplacement** (after TestBenzeneDisplacement)

```python
class TestNaphthaleneDisplacement:
    """Test displacement on naphthalene (fused aromatic rings)"""

    def test_naphthalene_displacement_does_not_crash(self):
        """Naphthalene displacement runs without crashing"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccc2ccccc2c1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(42)

        for _ in range(100):
            result = attempt_displacement(graph, rng)
            if result is not None:
                assert result.is_connected()
                assert result.has_valid_valences()

    def test_naphthalene_displacement_success_rate(self):
        """Naphthalene displacement succeeds >= 40% of 500 attempts"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccc2ccccc2c1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(42)

        successes = sum(1 for _ in range(500) if attempt_displacement(graph, rng) is not None)
        success_rate = successes / 500

        assert success_rate >= 0.40, \
            f"Naphthalene displacement success rate {success_rate:.1%} below 40% minimum"

    def test_naphthalene_preserves_atom_count(self):
        """Naphthalene displacement preserves 10 atoms"""
        from rdkit import Chem
        mol = Chem.MolFromSmiles('c1ccc2ccccc2c1')
        graph = MoleculeGraph(mol)
        rng = SeededRandom(888)

        for _ in range(100):
            result = attempt_displacement(graph, rng)
            if result is not None:
                assert result.get_atom_count() == 10
```
  </action>
  <verify>
1. `cd backend && python -m pytest tests/test_displacement.py -v` -- all tests pass including new benzene and naphthalene tests
2. `cd backend && python -m pytest tests/test_displacement.py -v -k "Benzene"` -- benzene tests specifically pass
3. `cd backend && python -m pytest tests/test_displacement.py -v -k "Naphthalene"` -- naphthalene tests specifically pass
  </verify>
  <done>Benzene displacement succeeds >= 85% with no crashes. Naphthalene displacement succeeds >= 40% with no crashes. All existing displacement tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add SA engine integration tests for unsaturated and preset molecules</name>
  <files>backend/tests/test_sa_engine.py</files>
  <action>
Add two new test classes to the existing test_sa_engine.py file.

**Class 1: TestUnsaturatedMolecules** - Full SA runs on unsaturated molecules

```python
class TestUnsaturatedMolecules:
    """Test SA engine on unsaturated/aromatic molecules"""

    def test_benzene_sa_completes(self):
        """Full SA on C6H6 completes without crashing"""
        params = SAParams(
            formula='C6H6',
            initial_temp=100,
            cooling_schedule_k=8,
            steps_per_cycle=200,
            num_cycles=2,
            optimization_mode='MINIMIZE',
            seed=42,
        )
        engine = SAEngine(params)
        result = engine.run()

        assert result.best_smiles is not None
        assert len(result.best_smiles) > 0
        assert result.total_steps == 400
        assert result.accepted_moves + result.rejected_moves + result.invalid_moves == 400

    def test_naphthalene_sa_completes(self):
        """Full SA on C10H8 completes without crashing"""
        params = SAParams(
            formula='C10H8',
            initial_temp=100,
            cooling_schedule_k=8,
            steps_per_cycle=200,
            num_cycles=2,
            optimization_mode='MINIMIZE',
            seed=42,
        )
        engine = SAEngine(params)
        result = engine.run()

        assert result.best_smiles is not None
        assert len(result.best_smiles) > 0
        assert result.total_steps == 400

    def test_monoterpene_sa_completes(self):
        """Full SA on C10H16 (monoterpene) completes without crashing"""
        params = SAParams(
            formula='C10H16',
            initial_temp=100,
            cooling_schedule_k=8,
            steps_per_cycle=200,
            num_cycles=2,
            optimization_mode='MINIMIZE',
            seed=42,
        )
        engine = SAEngine(params)
        result = engine.run()

        assert result.best_smiles is not None
        assert len(result.best_smiles) > 0
```

**Class 2: TestAllPresetMolecules** - Verify all frontend presets work

```python
import pytest

class TestAllPresetMolecules:
    """Verify all frontend preset molecules run through SA without errors.

    These are the presets defined in src/ui/presets.ts that users
    can select from the Quick Start dropdown.
    """

    @pytest.mark.parametrize("formula,name", [
        ('C6H14', 'Hexane isomers'),
        ('C8H18', 'Octane isomers'),
        ('C8H10', 'Ethylbenzene / Xylenes'),
        ('C10H22', 'Decane isomers'),
        ('C10H16', 'Monoterpene isomers'),
        ('C10H8', 'Naphthalene isomers'),
    ])
    def test_preset_sa_completes(self, formula, name):
        """Preset '{name}' ({formula}) completes SA without errors"""
        params = SAParams(
            formula=formula,
            initial_temp=100,
            cooling_schedule_k=8,
            steps_per_cycle=100,
            num_cycles=2,
            optimization_mode='MINIMIZE',
            seed=42,
        )
        engine = SAEngine(params)
        result = engine.run()

        assert result.best_smiles is not None, f"{name} ({formula}) produced no best SMILES"
        assert len(result.best_smiles) > 0, f"{name} ({formula}) produced empty SMILES"
        assert result.total_steps == 200
        assert result.acceptance_ratio >= 0, f"{name} ({formula}) has negative acceptance ratio"
```

Ensure the necessary imports are present at the top of test_sa_engine.py:
- `from app.core.sa_engine import SAEngine`
- `from app.models.sa_params import SAParams` (both should already exist)
  </action>
  <verify>
1. `cd backend && python -m pytest tests/test_sa_engine.py -v -k "Unsaturated"` -- benzene, naphthalene, monoterpene SA tests pass
2. `cd backend && python -m pytest tests/test_sa_engine.py -v -k "Preset"` -- all 6 preset molecule tests pass
3. `cd backend && python -m pytest tests/ -v` -- full test suite passes with zero failures
  </verify>
  <done>Full SA optimization completes without crashing on C6H6, C10H8, and C10H16. All 6 frontend preset formulas (C6H14, C8H18, C8H10, C10H22, C10H16, C10H8) run through SA engine successfully. Zero test regressions across entire test suite.</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/ -v` -- entire test suite passes
2. Benzene displacement success rate >= 85%
3. Naphthalene displacement success rate >= 40%
4. All 6 preset formulas complete SA runs
5. No crashes with "Cannot map bond type AROMATIC to integer order"
6. All existing tests still pass (zero regressions)
</verification>

<success_criteria>
- All 6 frontend preset molecules (from src/ui/presets.ts) complete SA optimization without errors
- Displacement benchmarks document expected success rates for unsaturated molecules
- Full test suite passes with zero regressions
- Benzene and naphthalene displacement tests specifically verify the aromaticity fix works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-02-SUMMARY.md`
</output>
