---
phase: 06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/app/utils/rdkit_helpers.py
  - backend/app/core/molecule.py
  - backend/app/core/initial_structure.py
  - backend/tests/test_molecule.py
  - backend/tests/test_initial_structure.py
autonomous: true

must_haves:
  truths:
    - "Benzene (C6H6) created from SMILES or formula can undergo displacement without crashing"
    - "Naphthalene (C10H8) created from formula can undergo displacement without crashing"
    - "All SanitizeMol calls in molecule.py use kekulized sanitization (no aromaticity perception)"
    - "bond_type_to_order() handles AROMATIC bond type as safety fallback"
    - "to_smiles() generates Kekule SMILES (uppercase, no aromatic notation)"
    - "Existing saturated molecule tests still pass unchanged"
  artifacts:
    - path: "backend/app/utils/rdkit_helpers.py"
      provides: "sanitize_kekulized() helper and AROMATIC fallback in bond_type_to_order()"
      contains: "sanitize_kekulized"
    - path: "backend/app/core/molecule.py"
      provides: "Kekulized sanitization in set_bond(), has_valid_valences(), and kekuleSmiles in to_smiles()"
      contains: "sanitize_kekulized"
    - path: "backend/tests/test_molecule.py"
      provides: "Tests for benzene MoleculeGraph creation, bond reading, set_bond, to_smiles on aromatic molecules"
      contains: "benzene"
  key_links:
    - from: "backend/app/core/molecule.py"
      to: "backend/app/utils/rdkit_helpers.py"
      via: "import sanitize_kekulized"
      pattern: "from app.utils.rdkit_helpers import.*sanitize_kekulized"
    - from: "backend/app/core/molecule.py"
      to: "rdkit.Chem.MolToSmiles"
      via: "kekuleSmiles=True parameter"
      pattern: "kekuleSmiles=True"
---

<objective>
Fix the critical aromaticity bug that crashes displacement on unsaturated molecules (benzene, naphthalene, etc.) by introducing kekulized sanitization throughout the molecule handling code.

Purpose: RDKit auto-converts benzene to AROMATIC bond type (1.5 order) during SanitizeMol, but Faulon displacement requires integer bond orders (0-3). The fix disables aromaticity perception during sanitization to keep molecules in Kekule form (alternating single/double bonds).

Output: Working `sanitize_kekulized()` helper, updated `bond_type_to_order()` with AROMATIC fallback, kekulized `set_bond()`/`has_valid_valences()`/`to_smiles()`, comprehensive tests for aromatic molecule handling.
</objective>

<execution_context>
@/Users/steinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/steinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-RESEARCH.md
@backend/app/utils/rdkit_helpers.py
@backend/app/core/molecule.py
@backend/app/core/initial_structure.py
@backend/tests/test_molecule.py
@backend/tests/test_initial_structure.py
</context>

<feature>
  <name>Kekulized sanitization for Faulon-compatible aromatic molecule handling</name>
  <files>backend/app/utils/rdkit_helpers.py, backend/app/core/molecule.py, backend/app/core/initial_structure.py, backend/tests/test_molecule.py, backend/tests/test_initial_structure.py</files>
  <behavior>
    Expected behavior in testable terms:

    1. sanitize_kekulized(mol) sanitizes without converting to aromatic bonds:
       - Input: RWMol of benzene with alternating SINGLE/DOUBLE bonds
       - Expected: All bonds remain SINGLE or DOUBLE (no AROMATIC type)

    2. bond_type_to_order(BondType.AROMATIC) returns 1 (safety fallback):
       - Input: BondType.AROMATIC
       - Expected: 1 (not crash)

    3. MoleculeGraph created from benzene SMILES "C1=CC=CC=C1" can read bond orders:
       - get_bond_order(0,1) returns 1 or 2 (not crash on AROMATIC)
       - get_bond_order_sum(any_atom) returns integer value
       - get_implicit_h(any_atom) returns correct count

    4. MoleculeGraph.set_bond() on kekulized benzene does not crash:
       - Input: kekulized benzene, set_bond(0, 1, 1) (valid change)
       - Expected: succeeds without "Cannot map bond type AROMATIC" error

    5. MoleculeGraph.to_smiles() produces Kekule SMILES:
       - Input: kekulized benzene
       - Expected: uppercase SMILES like "C1=CC=CC=C1" (not "c1ccccc1")

    6. has_valid_valences() works on kekulized benzene:
       - Input: kekulized benzene
       - Expected: returns True (not crash during validation)

    7. generate_initial_structure("C6H6") produces kekulized output:
       - Expected: 6 atoms, 6 implicit H, connected, valid valences, no AROMATIC bonds

    8. All existing saturated molecule tests pass unchanged:
       - hexane, pentane, cyclohexane, isobutane, neopentane tests still green
  </behavior>
  <implementation>
    **Step 1: Add sanitize_kekulized() to rdkit_helpers.py**

    Add new function after existing functions:
    ```python
    from rdkit.Chem import rdmolops

    def sanitize_kekulized(mol: Chem.Mol) -> None:
        """Sanitize molecule while preserving Kekule form (no aromaticity perception).

        Use this instead of Chem.SanitizeMol() for molecules undergoing
        Faulon displacement, which requires integer bond orders (0-3).

        AROMATIC bond type (1.5 order) is incompatible with displacement
        equations 7-11. This function runs ALL sanitization checks EXCEPT
        SetAromaticity, keeping bonds as SINGLE/DOUBLE/TRIPLE.

        Args:
            mol: RDKit Mol object to sanitize (modified in place)

        Raises:
            Exception: If sanitization fails (e.g., valence violations)
        """
        sanitize_ops = (rdmolops.SanitizeFlags.SANITIZE_ALL &
                       ~rdmolops.SanitizeFlags.SANITIZE_SETAROMATICITY)
        Chem.SanitizeMol(mol, sanitizeOps=sanitize_ops)
    ```

    **Step 2: Add AROMATIC fallback to bond_type_to_order()**

    Update the type_map dict in bond_type_to_order():
    ```python
    type_map = {
        BondType.UNSPECIFIED: 0,
        BondType.SINGLE: 1,
        BondType.DOUBLE: 2,
        BondType.TRIPLE: 3,
        BondType.AROMATIC: 1,  # Fallback for safety; prefer kekulization
    }
    ```

    **Step 3: Update molecule.py to use sanitize_kekulized()**

    Add import:
    ```python
    from app.utils.rdkit_helpers import order_to_bond_type, bond_type_to_order, sanitize_kekulized
    ```

    Update `set_bond()` (line 130):
    - Replace `Chem.SanitizeMol(self._mol)` with `sanitize_kekulized(self._mol)`

    Update `has_valid_valences()` (line 161):
    - Replace `Chem.SanitizeMol(mol_copy)` with `sanitize_kekulized(mol_copy)`

    Update `to_smiles()` (line 197):
    - Replace `Chem.MolToSmiles(mol_copy)` with `Chem.MolToSmiles(mol_copy, kekuleSmiles=True)`

    Update `__init__()` constructor:
    - After creating RWMol copy, call `sanitize_kekulized(self._mol)` to ensure any molecule
      passed in (potentially with aromatic bonds from external SMILES) gets kekulized on entry.
      This is the critical entry point -- molecules created from `Chem.MolFromSmiles('c1ccccc1')`
      will have AROMATIC bonds that must be kekulized before displacement can work.
    - Before sanitize_kekulized, call `Chem.Kekulize(self._mol, clearAromaticFlags=True)` to
      convert AROMATIC bonds to alternating SINGLE/DOUBLE. sanitize_kekulized alone won't
      convert existing AROMATIC bonds -- it only prevents NEW aromaticity detection.

    Update factory methods (`create_linear_alkane`, `create_cyclohexane`, `create_branched`):
    - Replace `Chem.SanitizeMol(mol)` with `sanitize_kekulized(mol)` for consistency.
      These produce saturated molecules that won't trigger aromaticity, but using the
      kekulized helper consistently prevents future bugs if formulas change.

    **Step 4: Update initial_structure.py sanitization**

    Import sanitize_kekulized:
    ```python
    from app.utils.rdkit_helpers import sanitize_kekulized
    ```

    Replace line 167 `Chem.SanitizeMol(mol)` with `sanitize_kekulized(mol)`.
    Replace line 75 `Chem.SanitizeMol(mol)` with `sanitize_kekulized(mol)`.

    **Step 5: Add aromatic molecule tests to test_molecule.py**

    Add new test class `TestAromaticMolecules`:

    ```python
    class TestAromaticMolecules:
        """Test handling of aromatic/unsaturated molecules"""

        def test_benzene_from_kekule_smiles(self):
            """Benzene from Kekule SMILES 'C1=CC=CC=C1' creates valid graph"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('C1=CC=CC=C1')
            graph = MoleculeGraph(mol)
            assert graph.get_atom_count() == 6
            assert graph.is_connected()
            assert graph.has_valid_valences()

        def test_benzene_from_aromatic_smiles(self):
            """Benzene from aromatic SMILES 'c1ccccc1' creates valid graph (kekulized on entry)"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccccc1')
            graph = MoleculeGraph(mol)
            assert graph.get_atom_count() == 6
            assert graph.is_connected()
            assert graph.has_valid_valences()

        def test_benzene_bond_orders_are_integers(self):
            """Benzene bonds are SINGLE(1) or DOUBLE(2), never AROMATIC"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccccc1')
            graph = MoleculeGraph(mol)
            for i in range(6):
                for j in range(i + 1, 6):
                    order = graph.get_bond_order(i, j)
                    assert order in (0, 1, 2), f"Bond ({i},{j}) has order {order}, expected 0/1/2"

        def test_benzene_set_bond_does_not_crash(self):
            """set_bond on kekulized benzene succeeds (no AROMATIC error)"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccccc1')
            graph = MoleculeGraph(mol)
            # Find a single bond and verify we can modify it
            # (exact behavior depends on kekulization pattern, just verify no crash)
            try:
                clone = graph.clone()
                # This should NOT raise "Cannot map bond type AROMATIC"
                _ = clone.get_bond_order_sum(0)
            except ValueError as e:
                pytest.fail(f"Bond operation on benzene crashed: {e}")

        def test_benzene_to_smiles_is_kekule(self):
            """to_smiles() on benzene produces uppercase Kekule SMILES (not aromatic lowercase)"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccccc1')
            graph = MoleculeGraph(mol)
            smiles = graph.to_smiles()
            # Kekule SMILES uses uppercase C and = signs
            assert smiles == smiles.upper() or '=' in smiles, \
                f"Expected Kekule SMILES, got aromatic: {smiles}"
            assert 'c' not in smiles, f"Aromatic lowercase 'c' found in SMILES: {smiles}"

        def test_naphthalene_from_smiles(self):
            """Naphthalene creates valid graph with integer bond orders"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccc2ccccc2c1')  # Aromatic SMILES
            graph = MoleculeGraph(mol)
            assert graph.get_atom_count() == 10
            assert graph.is_connected()
            assert graph.has_valid_valences()

        def test_naphthalene_implicit_h(self):
            """Naphthalene (C10H8) has 8 implicit H total"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccc2ccccc2c1')
            graph = MoleculeGraph(mol)
            total_h = sum(graph.get_implicit_h(i) for i in range(10))
            assert total_h == 8

        def test_has_valid_valences_benzene(self):
            """has_valid_valences() returns True for benzene (not crash)"""
            from rdkit import Chem
            mol = Chem.MolFromSmiles('c1ccccc1')
            graph = MoleculeGraph(mol)
            assert graph.has_valid_valences()
    ```

    **Step 6: Add initial structure test for C6H6 kekulization to test_initial_structure.py**

    Add test to TestUnsaturation class:

    ```python
    def test_benzene_formula_no_aromatic_bonds(self):
        """C6H6 initial structure has only SINGLE/DOUBLE bonds (no AROMATIC)"""
        from rdkit import Chem
        graph = generate_initial_structure('C6H6')
        mol = graph.get_mol()
        for bond in mol.GetBonds():
            bt = bond.GetBondType()
            assert bt in (Chem.BondType.SINGLE, Chem.BondType.DOUBLE, Chem.BondType.TRIPLE), \
                f"Found bond type {bt}, expected SINGLE/DOUBLE/TRIPLE"
    ```
  </implementation>
</feature>

<verification>
1. `cd backend && python -m pytest tests/test_molecule.py -v` -- all tests pass including new aromatic tests
2. `cd backend && python -m pytest tests/test_initial_structure.py -v` -- all tests pass including kekulization test
3. `cd backend && python -m pytest tests/ -v` -- full test suite passes (no regressions)
4. `grep -c 'sanitize_kekulized' backend/app/core/molecule.py` returns >= 3 (set_bond, has_valid_valences, constructor)
5. `grep 'kekuleSmiles=True' backend/app/core/molecule.py` finds the to_smiles fix
6. `grep 'AROMATIC' backend/app/utils/rdkit_helpers.py` finds the fallback mapping
7. `grep -c 'Chem.SanitizeMol' backend/app/core/molecule.py` returns 0 (all replaced with sanitize_kekulized)
</verification>

<success_criteria>
- Benzene (aromatic SMILES input) creates a valid MoleculeGraph with integer bond orders
- set_bond() on kekulized benzene does not crash with AROMATIC error
- to_smiles() produces Kekule notation (uppercase, no lowercase aromatic)
- has_valid_valences() works on aromatic molecules
- All existing 15+ tests in test_molecule.py and test_initial_structure.py still pass
- Zero raw Chem.SanitizeMol() calls remain in molecule.py (all use sanitize_kekulized)
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-fix-presets-and-displacement-efficiency-for-unsaturated-molecule-demo/06.1-01-SUMMARY.md`
</output>
